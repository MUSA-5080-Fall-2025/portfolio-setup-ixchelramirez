"0","library(FNN)"
"0","library(dplyr)"
"0",""
"0","# get unique station coordinates"
"0","stations <- study_panel %>%"
"0","  distinct(start_station, start_lat.y, start_lon.y)"
"0",""
"0","coords <- stations %>% select(start_lat.y, start_lon.y) %>% as.matrix()"
"0",""
"0","# Find 5-nearest neighbors (excluding station itself)"
"0","knn_res <- get.knn(coords, k = 5)"
"0",""
"0","# store neighbor indices"
"0","stations$neighbors <- knn_res$nn.index"
"0",""
"0","# Expand neighbor list"
"0","neighbor_map <- stations %>%"
"0","  mutate(neighbor_station = neighbors) %>%"
"0","  unnest(neighbor_station) %>%"
"0","  left_join(stations %>% select(start_station, start_lat.y, start_lon.y),"
"0","            by = c(""neighbor_station"" = ""start_station""))"
"0",""
"0","# Join neighbor info back to the panel"
"0","study_panel_neighbors <- study_panel %>%"
"0","  left_join(neighbor_map %>% select(start_station, neighbor_station),"
"0","            by = ""start_station"") %>%"
"0","  left_join("
"0","    study_panel %>% select(interval60, start_station, Trip_Count),"
"0","    by = c(""interval60"", ""neighbor_station"" = ""start_station"")"
"0","  )"
"0",""
"0","# Compute mean demand of neighbors"
"0","spatial_lag_knn <- study_panel_neighbors %>%"
"0","  group_by(interval60, start_station) %>%"
"0","  summarize("
"0","    Trip_Count = first(Trip_Count.x),"
"0","    mean_neighbor_demand = mean(Trip_Count.y, na.rm = TRUE)"
"0","  )"
"0",""
"0",""
