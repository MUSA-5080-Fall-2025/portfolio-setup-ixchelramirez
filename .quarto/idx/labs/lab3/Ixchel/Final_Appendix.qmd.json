{"title":"Philadelphia Housing Model Technical Appendix","markdown":{"yaml":{"title":"Philadelphia Housing Model Technical Appendix","author":"Ixchel Ramirez","date":"2025-10-27","format":"html","theme":"cosmo","toc":true,"toc-location":"left","document-css":false,"link-citations":true,"lang":"en"},"headingText":"Phase 1: Data Preparation (Technical Appendix)","containsRefs":false,"markdown":"\n\n\n**Load and clean Philadelphia sales data:**\n\n```{r load and clean sales data}\n'warnings=false'\n\nlibrary(sf)\nlibrary(tigris)\nlibrary(tidycensus)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(caret)\nlibrary(scales)\n\n#load census key for later use\n#census_api_key(\"42bf8a20a3df1def380f330cf7edad0dd5842ce6\")\n\n#save data in url \nurl <- \"https://phl.carto.com/api/v2/sql?filename=opa_properties_public&format=geojson&skipfields=cartodb_id&q=SELECT+*+FROM+opa_properties_public\"\n\n#suppress warnings for clarity and read data as spatial object\nsuppressWarnings({\n property_data <- st_read(url)\n})\n\n#clean data\nparcel_data <- property_data%>%\n  select(location, #load columns that could potentially be used as predictors \n         category_code_description, #maybe garage_spaces \n         number_of_bedrooms,\n         number_of_bathrooms, \n         total_livable_area,\n         year_built,\n         exterior_condition,\n         garage_spaces,\n         sale_price,\n         sale_date)%>%\n  filter(category_code_description %in% \n  c(\"SINGLE FAMILY\",\"MULTI FAMILY\"))%>% #no apartments, sales price of building\n  drop_na(number_of_bedrooms, #remove anomalies like houses with no rooms\n          number_of_bathrooms,\n          total_livable_area,\n          sale_price,\n          year_built) %>%\n  filter(number_of_bedrooms>0, \n         number_of_bathrooms>0,\n         total_livable_area>0, \n         sale_price>=10000, sale_price <=1000000)%>% #remove very low/high prices\n  mutate(sale_year = str_remove(sale_date, \"-.*\"))%>%   \n  filter(sale_year %in% c(\"2023\",\"2024\")) #isolate to 2023 and 2024\n\n```\n\n**Load Secondary data:**\n\n- Census data (tidycensus):\n- Spatial amenities (OpenDataPhilly)\n\n```{r load and clean census and spatial data}\n\n#load data about poverty(counts and total), bachelors(counts and total), and income \ncensus_data <- get_acs(\n  geography = \"tract\",\n  state = \"PA\",\n  county = \"Philadelphia\",\n  variables = c(\n    median_income = \"B19013_001\",\n    num_with_bach = \"B15003_022\",\n    bachelors_total =\"B15003_001\",\n    num_in_poverty = \"B17001_002\",\n    poverty_total =\"B17001_001\"\n  ),\n  year = 2022,\n  output = \"wide\"\n)\n\n#create percentage columns for bachelors and poverty \nphilly_census <- census_data%>%\n  mutate(\n    percentage_bach = num_with_bachE / bachelors_totalE,\n    percentage_pov =  num_in_povertyE / poverty_totalE\n  )\n\n#remove data errors or incomplete fields \nphilly_census <- philly_census%>%\n  drop_na(median_incomeE)%>%\n  filter(median_incomeE>0)\n\nphilly_census\n\n#spatial census data \nphiladelphia_tracts <- tracts(\n  state = \"PA\",\n  county = \"Philadelphia\",\n  cb = TRUE,\n  year = 2022\n)\n\n#join census data and tract geometry to PARCEL data\nparcel_data <- parcel_data %>%\n  st_transform(st_crs(philadelphia_tracts))%>%\n  st_join(philadelphia_tracts, join = st_within)%>%\n  left_join(philly_census, by = \"GEOID\")\n\n#load university data\nuniversity_data <- st_read(\"../data/Universities_Colleges.geojson\")\n\n#load 2024 crime incident data\ncrime_data <-st_read(\"../data/incidents_part1_part2.shp\")\n\n#removed crime incidents with no geometry \ncrime_data <- crime_data %>%\n  filter(!st_is_empty(geometry))\n\n#load neighborhood data \nneighborhoods <- st_read(\"../data/philadelphia-neighborhoods.shp\")\n\n```\n**Summary Table:**\n\n```{r summary table}\n#BEFORE CLEANING\n# Census data before cleaning\nbefore_census_dim <- dim(census_data)\nbefore_census_summary <- summary(census_data)\n\n#AFTER CLEANING\nafter_census_dim <- dim(philly_census)\nafter_census_summary <- summary(philly_census)\n\n# Summary table comparing before/after\ndata.frame(\n  Stage = c(\"Before Cleaning\", \"After Cleaning\"),\n  Rows = c(before_census_dim[1], after_census_dim[1]),\n  Columns = c(before_census_dim[2], after_census_dim[2])\n)\n\n\n```\n**Choice for Data Cleaning**\n\nBefore starting the analysis it is necessary to clean each of the datasets to remove anomalies like houses with no rooms. Although we were looking at residential properties we did not include apartment building as it assigned the sale price of each apartment as the sale price of the building so this was removed. Hence, we are left with homes which mean they will include rooms. We also removed residential locations with sale prices under 10000 or over 1000000 which are very low and high prices and isolated parcel data to data between 2023 and 2024. Census data cleaning involved removing data errors or incomplete fields and adding a column to reflect percentages. The Census data started off with 408 rows and ended with 383 after the cleaning choices.\nOther data that is also included is university and college locations, crime locations and neighborhood. These are cleaned in a later portion and involve transforming the coordinate reference system so that everything corresponds before filtering and re-categorizing data to help with interpretation \n\n\n**Cleaning Data Continued: Not Census or Parcel Data**\n\n```{r}\n\n#set crs for distance calculations\ncrime_proj <- st_transform(crime_data, 3365)\nparcel_proj <- st_transform(parcel_data, 3365)\nuniversity_proj <- st_transform(university_data, 3365)\nneighborhood_proj <-st_transform(neighborhoods, 3365)\n\n#logged sale price for comparison and modeling \nparcel_data <- parcel_data%>%\n  mutate(log_sale_price = log(sale_price))\n\nparcel_data <- parcel_data%>%\n  mutate(log_livable_area = log(total_livable_area))\n```\n\n\nDistance to nearest college - this is a feature engineering component but needs to be run here for map 4 in phase 2\n```{r feature engineering:knn }\n#Distance to nearest college\nuniversity_proj <- st_transform(university_data, 3365)\n\n\ndist_matrix <- st_distance(parcel_proj, university_proj)\n\n\nget_knn_distance <- function(dist_matrix, k) {\n  apply(dist_matrix, 1, function(distances) {\n    mean(as.numeric(sort(distances)[1:k]))\n  })\n}\n\nparcel_data$college_nn1 <- get_knn_distance(dist_matrix, k = 1)\nparcel_data$college_nn3 <- get_knn_distance(dist_matrix, k = 3)\nparcel_data$college_nn5 <- get_knn_distance(dist_matrix, k = 5)\n\nparcel_data %>%\n  st_drop_geometry() %>%\n  select(sale_price, college_nn1, college_nn3, college_nn5) %>%\n  cor(use = \"complete.obs\") %>%\n  as.data.frame() %>%\n  select(sale_price)\n\n```\n\n\n\n### Phase 2: Exploratory Data Analysis\n\n**Create at least 5 professional visualizations:**\n\n1. Distribution of sale prices (histogram)\n2. Geographic distribution (map)\n3. Price vs. structural features (scatter plots)\n4. Price vs. spatial features (scatter plots)\n5. One creative visualization\n\n**For appendix:** Include all visualizations with detailed interpretations\n1. Distribution of sale prices\n```{r distribution of sales}\n\nggplot(parcel_data, aes(x = sale_price)) +\n  geom_histogram(binwidth = 25000, fill = \"#1f78b4\", color = \"white\") +\n  scale_x_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Distribution of Philadelphia Sale Prices (2023-2024)\",\n    x = \"Sale Price ($)\",\n    y = \"Number of Properties\"\n  ) +\n  theme_minimal()\n\n```\nThe graph above shows the highest concentration of parcel sale prices is around\" `$200,000`. The histogram is right-skewed which means most sale prices are concentrated on the left side between zero and `$375,000`. In such a case the mean is generally greater than the median because the tail  on the right could inflate the mean. This affects the model's prediction for lower income homes. \n\n2. Geographic distribution (map)\n```{r geographic distribution}\n\nlibrary(tmap)\n\ntmap_mode(\"view\")  # interactive map; use \"plot\" for static\n\ntm_shape(parcel_data) +\n  tm_dots(\n    col = \"sale_price\",\n    palette = \"YlOrRd\",\n    style = \"quantile\",\n    title = \"Sale Price ($)\",\n    size = 0.05,\n    alpha = 0.7\n  ) +\n  tm_basemap(\"OpenStreetMap\") +\n  tm_layout(title = \"Geographic Distribution of Sale Prices in Philadelphia\")\n\n\n```\nThe geographic distribution of sale prices in Philadelphia shows that the most expensive sales were around Center City, North West Philadelphia and North East Philadelphia Airport.The lowest sales are in South and North Philadelphia. There is little transition from areas with a high sale price to areas with a low sale price.\n\n\n3. Price vs. structural features (scatter plots)\n```{r price vs structural scatter plots}\n\n# Sale Price vs Total Livable Area\nggplot(parcel_data, aes(x = total_livable_area, y = sale_price)) +\n  geom_point(alpha = 0.5, color = \"#33a02c\") +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Sale Price vs Total Livable Area\",\n    x = \"Total Livable Area (sq ft)\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal() +\n  geom_smooth(method = \"lm\", col = \"darkgreen\")\n  \n# Sale Price vs Number of Bathrooms\nggplot(parcel_data, aes(x = number_of_bathrooms, y = sale_price)) +\n  geom_jitter(alpha = 0.5, width = 0.2, color = \"darkgreen\") +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Sale Price vs Number of Bathrooms\",\n    x = \"Number of Bathrooms\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal()\n\n\n# Sale Price vs Number of Bedrooms\nggplot(parcel_data, aes(x = number_of_bedrooms, y = sale_price)) +\n  geom_jitter(alpha = 0.5, width = 0.2, color = \"darkgreen\") +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Sale Price vs Number of Bedrooms\",\n    x = \"Number of Bedrooms\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal()\n\n\n```\nMost places have a total livable area under 3000 sq ft, by 4000 sq ft the number is very sparce. Since the maximum for sale price is capped at `$1,000,000` there is a hard stop at this point on the y-axis. The most common type of sale was between zero to `$500,000` for 0 to 2000 total livable square feet.\n\nThe parcel that is sold the most contains 2 bathrooms and sales for under `$750,000`.\n\n\nWith respect to bathrooms the parcel that is sold the most contains 2 bathrooms and sales for under `$812,500`.\n\n4. Price vs. spatial features (scatter plots)\n```{r scatter plots}\n\n# Scatter plot: Sale Price vs Distance to Nearest College\nggplot(parcel_data, aes(x = college_nn1, y = sale_price)) +\n  geom_point(alpha = 0.5, color = \"#6a3d9a\") +\n  geom_smooth(method = \"lm\", color = \"blue\", se = TRUE) +\n  scale_y_continuous(labels = dollar_format(prefix = \"$\")) +\n  scale_x_continuous(labels = comma_format(), limits = c(0, NA)) +\n  labs(\n    title = \"Sale Price vs Distance to Nearest College\",\n    subtitle = \"Distance calculated to the nearest university in feet\",\n    x = \"Distance to Nearest College (ft)\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal(base_size = 14)\n\n\n\n\n```\nThe Sale Price vs Distance to Nearest College Map shows that as parcels are further from colleges their sale price decreases slightly due to the slight negative slope of the line. \n\n\n5. Creative visualization - Heatmap of Bedrooms in Philadelphia \n```{r density map}\n\nlibrary(tmap)\ntmap_mode(\"plot\")\n\ntm_shape(parcel_proj) +\n  tm_dots(\n    col = \"number_of_bedrooms\",\n    palette = \"YlOrRd\",\n    style = \"cont\",\n    size = 0.05,\n    alpha = 0.5,\n    title = \"Number of Bedrooms\"\n  ) +\n  tm_layout(\n    main.title = \"Spatial Distribution of Bedrooms in Philadelphia Homes\",\n    legend.outside = TRUE\n  )\n\n\n\n```\nMost areas have 2 bedrooms but there are several pockets such as slightly North of Center City and West Philadelphia which have a higher number of bedrooms.\n\n\n### Phase 3: Feature Engineering\n\n1. **Buffer-based features**:\n\n   - Violent Crimes within 600ft\n\n2. **k-Nearest Neighbor features**:\n\n   - Average distance from parcel to 1, 3, and 5 nearest colleges and university buildings. Code written above in order to map feature.\n   \n3. **Census variables**:\n\n   - Join median income, percentage with a bachelor's degree, and poverty percentage \n\n4. **Interaction terms**:\n\n   - Wealthy neighborhoods which take into account if a home is in a wealthy neighborhood which is based on median sale price.\n   \n5. **Other features**:\n\n   - log_sale_price, log_livable_area, age and exterior condition (if it is good or not)\n\n\n**Feature Engineering Code**\n\n```{r feature engineering:buffer }\nparcel_proj <- parcel_proj %>% filter(!st_is_empty(.)) %>% st_make_valid()\n#Number of violent crimes in proximity \nparcel_buffers<- st_buffer(parcel_proj, dist=600)\n\nviolent_crimes <- c(\n  \"Homicide - Criminal\",\n  \"Aggravated Assault No Firearm\",\n  \"Robbery Firearm\",\n  \"Aggravated Assault Firearm\")\n\nviolent_proj <- crime_proj %>%\n  filter(text_gener %in% violent_crimes)\n    \nviolent_crime_counts <- st_intersects(parcel_buffers, violent_proj)\nviolent_crime_counts <- lengths(violent_crime_counts)\n\n#join by row numner\nparcel_data <- parcel_data %>%\n  mutate(violent_crime_600ft = violent_crime_counts[1:nrow(parcel_data)])\n\n\n\n```\n\n```{r}\n#relationship to age\nparcel_data <- parcel_data %>%\n  mutate(year_built = as.numeric(year_built))%>%\n  mutate(Age = 2025 - year_built)%>% filter(Age <2000)\n\n```\n\n```{r}\n\nparcel_data <- parcel_data %>%\n  filter(exterior_condition != 0) %>%\n  mutate(\n    exterior_good = case_when(\n      exterior_condition >= 1 & exterior_condition <= 5 ~ 1,\n      exterior_condition >= 6 & exterior_condition <= 9 ~ 0,\n      TRUE ~ NA_real_ \n    )\n  )\n\n\n```\n\n```{r interaction: as.factor}\n#interaction effects\nparcel_proj <- st_transform(parcel_data, 3365)\nneighborhood_proj <-st_transform(neighborhoods, 3365)\n\nparcel_with_neighborhood <-  st_join(parcel_proj, neighborhood_proj, join = st_within)%>%\n  st_drop_geometry()%>%\n  group_by(NAME) %>%\n  summarize(median_price = median(sale_price, na.rm = TRUE))\n\n\nwealthy_neighborhoods <- parcel_with_neighborhood%>%\n  filter(median_price >= 275500)%>%\n  pull(NAME)\n\n#changed wealthy_list to wealthy_neighborhoods because wealthy_list did not exist \nparcel_data <- parcel_proj %>%\n  st_join(neighborhood_proj, join = st_within) %>%\n  mutate(\n    wealthy_neighborhood = ifelse(NAME %in% wealthy_neighborhoods, \"Wealthy\", \"Not Wealthy\"),\n    wealthy_neighborhood = as.factor(wealthy_neighborhood)\n  )\nparcel_data <- parcel_data %>%\n  relocate(wealthy_neighborhood, .after = MAPNAME)\nView(st_drop_geometry(parcel_data))\n\n```\n\n\n```{r}\n#price vs. spatial features\n\nplot(parcel_data$violent_crime_600ft, parcel_data$sale_price)\nplot(parcel_data$college_nn1, parcel_data$sale_price)\nplot(parcel_data$wealthy_neighborhood, parcel_data$sale_price)\n\n```\n\n\nCreating Summary Table\n```{r}\n#Summary table of engineered features\n\n# Create a data frame summarizing each feature\nfeature_summary <- data.frame(\n  Feature_Name = c(\n    \"violent_crime_600ft\",\n    \"college_nn1\",\n    \"college_nn3\",\n    \"college_nn5\",\n    \"median_incomeE\",\n    \"percentage_bach\",\n    \"percentage_pov\",\n    \"wealthy_neighborhood\",\n    \"log_sale_price\",\n    \"log_livable_area\",\n    \"Age\",\n    \"exterior_good\"\n  ),\n  Feature_Type = c(\n    \"Buffer-based (spatial)\",\n    \"kNN (spatial distance)\",\n    \"kNN (spatial distance)\",\n    \"kNN (spatial distance)\",\n    \"Census (socioeconomic)\",\n    \"Census (education)\",\n    \"Census (poverty)\",\n    \"Interaction term (categorical)\",\n    \"Transformation (continuous)\",\n    \"Transformation (continuous)\",\n    \"Structural (numeric)\",\n    \"Condition (binary)\"\n  ),\n  Description = c(\n    \"Count of violent crimes within 600 ft of parcel\",\n    \"Average distance to nearest college/university (k=1)\",\n    \"Average distance to 3 nearest colleges/universities\",\n    \"Average distance to 5 nearest colleges/universities\",\n    \"Median household income of census tract\",\n    \"Percent of tract population with bachelor's degree\",\n    \"Percent of tract population below poverty line\",\n    \"Indicates parcels located in wealthy neighborhoods\",\n    \"Natural log of sale price\",\n    \"Natural log of total livable area (sq ft)\",\n    \"Years since building construction\",\n    \"1 = good/average exterior, 0 = poor\"\n  ),\n  Justification = c(\n    \"Captures neighborhood safety and crime exposure\",\n    \"Measures proximity to educational amenities\",\n    \"Captures local educational accessibility\",\n    \"Captures broader proximity to higher education hubs\",\n    \"Represents economic conditions of local area\",\n    \"Education level could be connected to property values\",\n    \"Reflects socioeconomic disadvantage\",\n    \"Identifies context of neighborhood wealth levels\",\n    \"Stabilizes variance for regression modeling\",\n    \"Normalizes skewed size variable for modeling\",\n    \"Accounts for how homes are desireable when they are historic but devalued when they are too old\",\n    \"Changed categorical condition to numeric to understand exterior desirability\"\n  )\n)\n\n# Print table nicely\nlibrary(knitr)\nkable(feature_summary, caption = \"Summary of Engineered Features\", align = \"l\")\n\n\n```\n\n**Justification:**\nThe features included were engineered to capture social, economic, and environmental factors influencing housing prices. Buffer-based and k nearest-neighbor measures quantify local accessibility and safety. Census data helps to enrich parcels with socio-economic context. Interaction terms account for neighborhood-level wealth which helps contextualize external features of a home, for instance homes in a wealthy neighborhood are more likely to have a higher property value than those in other neighborhood. Applying a binary indicator improves model interpretability and performance for the external condition of a property. The table above includes why each feature was chosen.\n\n\n\n### Phase 4: **Models**\n\n**Model progression:**\n\n1. Structural features only\n2. + Census variables\n3. + Spatial features\n4. + Interactions and fixed effects\n\n**For appendix:**\n\n```{r code and summary}\nmodel1 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good, data = parcel_data)\n\nsummary(model1)\n\nmodel2 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov, data = parcel_data)\n\nsummary(model2)\n\nmodel3 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)\n\nsummary(model3)\n\nmodel4 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)\n\nsummary(model4)\n\nplot(fitted(model1), residuals(model1))\n\nplot(fitted(model2), residuals(model2))\n\nplot(fitted(model2), residuals(model2))\n\nplot(fitted(model3), residuals(model3))\n\n```\n\n***Coefficient interpretations:***\n\n\n### Phase 5: Model Validation\n\n```{r 10-fold cross-validation with scatter plots}\n\nparcel_data <- na.omit(parcel_data)\n\nctrl <- trainControl(\n  method = \"cv\",\n  number = 10  # 10-fold CV\n)\n\nmodel_cv1 <-  train(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl)\n\nmodel_cv1\n  \nmodel_cv2 <- train(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl\n)\n\nmodel_cv2\n\nmodel_cv3 <- train(log_sale_price ~ number_of_bathrooms + garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE + percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl\n)\n\nmodel_cv3\n\n\nmodel_cv4 <- train(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl\n)\n\nmodel_cv4\n\n\n#Impact of each feature summary\nsummary(model_cv4$finalModel)\n\n```\n\n\n```{r predicted vs actual}\n\nlibrary(ggplot2)\n\nggplot(parcel_data, aes(x = predict(model_cv4$finalModel), y = log_sale_price)) +\n  geom_point(alpha = 0.3) +\n  geom_abline(slope = 1, intercept = 0, color = \"red\") +\n  labs(x = \"Predicted log(Sale Price)\", y = \"Actual log(Sale Price)\",\n       title = \"Predicted vs Actual Sale Prices\") +\n  theme_minimal()\n\n\n\n\n\n```\n\n\n**Discuss which features matter the most:**\nThe features which matter the most are wealthy neighborhoods, log of livable areas, percentage with a bachelor's degree and percentage of poverty. The First three features have a positive effect while the percentage of poverty has a strong inverse effect.\n\n### Phase 6: Model Diagnostics \n\n**Check assumptions for best model:**\n\n- Residual plot (linearity, homoscedasticity)\n- Q-Q plot (normality)\n- Cook's distance (influential observations)\n\n```{r residual plot, q-q plot, and cooks distance}\n\n# Residuals vs Fitted\nplot(\n  fitted(model_cv4),\n  residuals(model_cv4),\n  main = \"Residuals vs Fitted Values\",\n  xlab = \"Fitted Values (Predicted Log Sale Price)\",\n  ylab = \"Residuals\",\n  pch = 19,\n  col = \"darkblue\"\n)\nabline(h = 0, col = \"red\", lwd = 2, lty = 2)\n\n# Q-Q plot for normality\nqqnorm(residuals(model_cv4)); qqline(residuals(model_cv4))\n\n\n# Cook's distance for the final lm model\nplot(cooks.distance(model4), type=\"h\", main=\"Cook's Distance\")\n\n\n\n```\n\n**Interpretation of plots** \nThe Residuals vs Fitted plot is around 0 but slightly curved. This means that it could be missing a non-linear term. We tried accounting for this by squaring the age of the home. \n\nThe Q-Q Plot shows that the model roughly follows a normal distribution which means using a linear regression makes sense. Ultimately this provides more confidence in our model.\n\nCooks distance shows many spikes that are the same with a few all ones. A few tall spikes is not concerning as most of them are around the same height but the one on the right side of the graph could indicate a possible outlier that was not accounted for.\n\n\n\n### Phase 7: Conclusions & Recommendations\n\n\n```{r}\n#neighborhoods that are hardest to predict \nparcel_data$residuals <- residuals(model_cv4$finalModel)\nparcel_data %>%\n  group_by(LISTNAME) %>%\n  summarize(mean_abs_resid = mean(abs(residuals))) %>%\n  arrange(desc(mean_abs_resid))\n\n\n```\n\n**Detailed Discussion:**\nThe final model explains approximately 59% of the variation in housing prices across Philadelphia, indicating a moderately strong fit. The Mean Absolute Error (MAE) of 0.34 suggests that the model’s predictions are off by about 34%. The RMSE score means that predictions are abou $154,200 off the true sale price. This level of accuracy is reasonable given the complexity and variability of the housing market. The most influential predictors of housing prices include wealthy neighborhoods, log of livable areas, percentage with a bachelor's degree, all of which have strong positive effects on property values. Conversely, the percentage of poverty and proximity to crime have strong negative relationships with home prices, underscoring how social perceptions of safety influence property values.\n\nNeighborhoods that are the hardest to predict tend to be those undergoing rapid change or instability, particularly areas experiencing gentrification, high prevalence of vacant and distressed properties or smaller sample areas. Examples of this are Nicetown, Fairhill, and Upper Kensington which are all located in North Philadelphia. In fact the top 10 locations which are the most hard to predict are all in North Philadelphia. Areas experiencing gentrification, rising educational attainment and declining crime rates occur alongside persistent vacancy and poverty, leading to non-linear effects that standard models struggle to account for. The rapid transformation in these neighborhoods contributes to greater residual errors. Thus, the model performs best in **mid-range markets** and is less stable in low-value areas. \n\nFrom an equity perspective, including socioeconomic indicators such as poverty and education levels improves predictive accuracy but also risks reproducing structural inequalities. By learning from historical patterns of disinvestment, the model may undervalue properties in low-income or historically marginalized neighborhoods. This raises ethical concerns when creating policy based on automated valuation models as it could inadvertently reinforce existing disparities. To mitigate this, residual analysis can be used to test for spatial bias, identifying neighborhoods where the model systematically under- or over-predicts values. Recognizing the limitations within the model highlights opportunities to inform equitable housing policy, such as directing investment initiatives or development funds toward historically undervalued areas rather than further harming them through biased valuation tools. Limitations while creating this model were not cleaning the data in a way that removed abnormalities such as homes that sold for a lot more than those nearby when looking at square footage and not including transportation data which would enrich our understanding of the property's spatial features.\n\n\n","srcMarkdownNoYaml":"\n\n### Phase 1: Data Preparation (Technical Appendix)\n\n**Load and clean Philadelphia sales data:**\n\n```{r load and clean sales data}\n'warnings=false'\n\nlibrary(sf)\nlibrary(tigris)\nlibrary(tidycensus)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(caret)\nlibrary(scales)\n\n#load census key for later use\n#census_api_key(\"42bf8a20a3df1def380f330cf7edad0dd5842ce6\")\n\n#save data in url \nurl <- \"https://phl.carto.com/api/v2/sql?filename=opa_properties_public&format=geojson&skipfields=cartodb_id&q=SELECT+*+FROM+opa_properties_public\"\n\n#suppress warnings for clarity and read data as spatial object\nsuppressWarnings({\n property_data <- st_read(url)\n})\n\n#clean data\nparcel_data <- property_data%>%\n  select(location, #load columns that could potentially be used as predictors \n         category_code_description, #maybe garage_spaces \n         number_of_bedrooms,\n         number_of_bathrooms, \n         total_livable_area,\n         year_built,\n         exterior_condition,\n         garage_spaces,\n         sale_price,\n         sale_date)%>%\n  filter(category_code_description %in% \n  c(\"SINGLE FAMILY\",\"MULTI FAMILY\"))%>% #no apartments, sales price of building\n  drop_na(number_of_bedrooms, #remove anomalies like houses with no rooms\n          number_of_bathrooms,\n          total_livable_area,\n          sale_price,\n          year_built) %>%\n  filter(number_of_bedrooms>0, \n         number_of_bathrooms>0,\n         total_livable_area>0, \n         sale_price>=10000, sale_price <=1000000)%>% #remove very low/high prices\n  mutate(sale_year = str_remove(sale_date, \"-.*\"))%>%   \n  filter(sale_year %in% c(\"2023\",\"2024\")) #isolate to 2023 and 2024\n\n```\n\n**Load Secondary data:**\n\n- Census data (tidycensus):\n- Spatial amenities (OpenDataPhilly)\n\n```{r load and clean census and spatial data}\n\n#load data about poverty(counts and total), bachelors(counts and total), and income \ncensus_data <- get_acs(\n  geography = \"tract\",\n  state = \"PA\",\n  county = \"Philadelphia\",\n  variables = c(\n    median_income = \"B19013_001\",\n    num_with_bach = \"B15003_022\",\n    bachelors_total =\"B15003_001\",\n    num_in_poverty = \"B17001_002\",\n    poverty_total =\"B17001_001\"\n  ),\n  year = 2022,\n  output = \"wide\"\n)\n\n#create percentage columns for bachelors and poverty \nphilly_census <- census_data%>%\n  mutate(\n    percentage_bach = num_with_bachE / bachelors_totalE,\n    percentage_pov =  num_in_povertyE / poverty_totalE\n  )\n\n#remove data errors or incomplete fields \nphilly_census <- philly_census%>%\n  drop_na(median_incomeE)%>%\n  filter(median_incomeE>0)\n\nphilly_census\n\n#spatial census data \nphiladelphia_tracts <- tracts(\n  state = \"PA\",\n  county = \"Philadelphia\",\n  cb = TRUE,\n  year = 2022\n)\n\n#join census data and tract geometry to PARCEL data\nparcel_data <- parcel_data %>%\n  st_transform(st_crs(philadelphia_tracts))%>%\n  st_join(philadelphia_tracts, join = st_within)%>%\n  left_join(philly_census, by = \"GEOID\")\n\n#load university data\nuniversity_data <- st_read(\"../data/Universities_Colleges.geojson\")\n\n#load 2024 crime incident data\ncrime_data <-st_read(\"../data/incidents_part1_part2.shp\")\n\n#removed crime incidents with no geometry \ncrime_data <- crime_data %>%\n  filter(!st_is_empty(geometry))\n\n#load neighborhood data \nneighborhoods <- st_read(\"../data/philadelphia-neighborhoods.shp\")\n\n```\n**Summary Table:**\n\n```{r summary table}\n#BEFORE CLEANING\n# Census data before cleaning\nbefore_census_dim <- dim(census_data)\nbefore_census_summary <- summary(census_data)\n\n#AFTER CLEANING\nafter_census_dim <- dim(philly_census)\nafter_census_summary <- summary(philly_census)\n\n# Summary table comparing before/after\ndata.frame(\n  Stage = c(\"Before Cleaning\", \"After Cleaning\"),\n  Rows = c(before_census_dim[1], after_census_dim[1]),\n  Columns = c(before_census_dim[2], after_census_dim[2])\n)\n\n\n```\n**Choice for Data Cleaning**\n\nBefore starting the analysis it is necessary to clean each of the datasets to remove anomalies like houses with no rooms. Although we were looking at residential properties we did not include apartment building as it assigned the sale price of each apartment as the sale price of the building so this was removed. Hence, we are left with homes which mean they will include rooms. We also removed residential locations with sale prices under 10000 or over 1000000 which are very low and high prices and isolated parcel data to data between 2023 and 2024. Census data cleaning involved removing data errors or incomplete fields and adding a column to reflect percentages. The Census data started off with 408 rows and ended with 383 after the cleaning choices.\nOther data that is also included is university and college locations, crime locations and neighborhood. These are cleaned in a later portion and involve transforming the coordinate reference system so that everything corresponds before filtering and re-categorizing data to help with interpretation \n\n\n**Cleaning Data Continued: Not Census or Parcel Data**\n\n```{r}\n\n#set crs for distance calculations\ncrime_proj <- st_transform(crime_data, 3365)\nparcel_proj <- st_transform(parcel_data, 3365)\nuniversity_proj <- st_transform(university_data, 3365)\nneighborhood_proj <-st_transform(neighborhoods, 3365)\n\n#logged sale price for comparison and modeling \nparcel_data <- parcel_data%>%\n  mutate(log_sale_price = log(sale_price))\n\nparcel_data <- parcel_data%>%\n  mutate(log_livable_area = log(total_livable_area))\n```\n\n\nDistance to nearest college - this is a feature engineering component but needs to be run here for map 4 in phase 2\n```{r feature engineering:knn }\n#Distance to nearest college\nuniversity_proj <- st_transform(university_data, 3365)\n\n\ndist_matrix <- st_distance(parcel_proj, university_proj)\n\n\nget_knn_distance <- function(dist_matrix, k) {\n  apply(dist_matrix, 1, function(distances) {\n    mean(as.numeric(sort(distances)[1:k]))\n  })\n}\n\nparcel_data$college_nn1 <- get_knn_distance(dist_matrix, k = 1)\nparcel_data$college_nn3 <- get_knn_distance(dist_matrix, k = 3)\nparcel_data$college_nn5 <- get_knn_distance(dist_matrix, k = 5)\n\nparcel_data %>%\n  st_drop_geometry() %>%\n  select(sale_price, college_nn1, college_nn3, college_nn5) %>%\n  cor(use = \"complete.obs\") %>%\n  as.data.frame() %>%\n  select(sale_price)\n\n```\n\n\n\n### Phase 2: Exploratory Data Analysis\n\n**Create at least 5 professional visualizations:**\n\n1. Distribution of sale prices (histogram)\n2. Geographic distribution (map)\n3. Price vs. structural features (scatter plots)\n4. Price vs. spatial features (scatter plots)\n5. One creative visualization\n\n**For appendix:** Include all visualizations with detailed interpretations\n1. Distribution of sale prices\n```{r distribution of sales}\n\nggplot(parcel_data, aes(x = sale_price)) +\n  geom_histogram(binwidth = 25000, fill = \"#1f78b4\", color = \"white\") +\n  scale_x_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Distribution of Philadelphia Sale Prices (2023-2024)\",\n    x = \"Sale Price ($)\",\n    y = \"Number of Properties\"\n  ) +\n  theme_minimal()\n\n```\nThe graph above shows the highest concentration of parcel sale prices is around\" `$200,000`. The histogram is right-skewed which means most sale prices are concentrated on the left side between zero and `$375,000`. In such a case the mean is generally greater than the median because the tail  on the right could inflate the mean. This affects the model's prediction for lower income homes. \n\n2. Geographic distribution (map)\n```{r geographic distribution}\n\nlibrary(tmap)\n\ntmap_mode(\"view\")  # interactive map; use \"plot\" for static\n\ntm_shape(parcel_data) +\n  tm_dots(\n    col = \"sale_price\",\n    palette = \"YlOrRd\",\n    style = \"quantile\",\n    title = \"Sale Price ($)\",\n    size = 0.05,\n    alpha = 0.7\n  ) +\n  tm_basemap(\"OpenStreetMap\") +\n  tm_layout(title = \"Geographic Distribution of Sale Prices in Philadelphia\")\n\n\n```\nThe geographic distribution of sale prices in Philadelphia shows that the most expensive sales were around Center City, North West Philadelphia and North East Philadelphia Airport.The lowest sales are in South and North Philadelphia. There is little transition from areas with a high sale price to areas with a low sale price.\n\n\n3. Price vs. structural features (scatter plots)\n```{r price vs structural scatter plots}\n\n# Sale Price vs Total Livable Area\nggplot(parcel_data, aes(x = total_livable_area, y = sale_price)) +\n  geom_point(alpha = 0.5, color = \"#33a02c\") +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Sale Price vs Total Livable Area\",\n    x = \"Total Livable Area (sq ft)\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal() +\n  geom_smooth(method = \"lm\", col = \"darkgreen\")\n  \n# Sale Price vs Number of Bathrooms\nggplot(parcel_data, aes(x = number_of_bathrooms, y = sale_price)) +\n  geom_jitter(alpha = 0.5, width = 0.2, color = \"darkgreen\") +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Sale Price vs Number of Bathrooms\",\n    x = \"Number of Bathrooms\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal()\n\n\n# Sale Price vs Number of Bedrooms\nggplot(parcel_data, aes(x = number_of_bedrooms, y = sale_price)) +\n  geom_jitter(alpha = 0.5, width = 0.2, color = \"darkgreen\") +\n  scale_y_continuous(labels = scales::dollar_format()) +\n  labs(\n    title = \"Sale Price vs Number of Bedrooms\",\n    x = \"Number of Bedrooms\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal()\n\n\n```\nMost places have a total livable area under 3000 sq ft, by 4000 sq ft the number is very sparce. Since the maximum for sale price is capped at `$1,000,000` there is a hard stop at this point on the y-axis. The most common type of sale was between zero to `$500,000` for 0 to 2000 total livable square feet.\n\nThe parcel that is sold the most contains 2 bathrooms and sales for under `$750,000`.\n\n\nWith respect to bathrooms the parcel that is sold the most contains 2 bathrooms and sales for under `$812,500`.\n\n4. Price vs. spatial features (scatter plots)\n```{r scatter plots}\n\n# Scatter plot: Sale Price vs Distance to Nearest College\nggplot(parcel_data, aes(x = college_nn1, y = sale_price)) +\n  geom_point(alpha = 0.5, color = \"#6a3d9a\") +\n  geom_smooth(method = \"lm\", color = \"blue\", se = TRUE) +\n  scale_y_continuous(labels = dollar_format(prefix = \"$\")) +\n  scale_x_continuous(labels = comma_format(), limits = c(0, NA)) +\n  labs(\n    title = \"Sale Price vs Distance to Nearest College\",\n    subtitle = \"Distance calculated to the nearest university in feet\",\n    x = \"Distance to Nearest College (ft)\",\n    y = \"Sale Price ($)\"\n  ) +\n  theme_minimal(base_size = 14)\n\n\n\n\n```\nThe Sale Price vs Distance to Nearest College Map shows that as parcels are further from colleges their sale price decreases slightly due to the slight negative slope of the line. \n\n\n5. Creative visualization - Heatmap of Bedrooms in Philadelphia \n```{r density map}\n\nlibrary(tmap)\ntmap_mode(\"plot\")\n\ntm_shape(parcel_proj) +\n  tm_dots(\n    col = \"number_of_bedrooms\",\n    palette = \"YlOrRd\",\n    style = \"cont\",\n    size = 0.05,\n    alpha = 0.5,\n    title = \"Number of Bedrooms\"\n  ) +\n  tm_layout(\n    main.title = \"Spatial Distribution of Bedrooms in Philadelphia Homes\",\n    legend.outside = TRUE\n  )\n\n\n\n```\nMost areas have 2 bedrooms but there are several pockets such as slightly North of Center City and West Philadelphia which have a higher number of bedrooms.\n\n\n### Phase 3: Feature Engineering\n\n1. **Buffer-based features**:\n\n   - Violent Crimes within 600ft\n\n2. **k-Nearest Neighbor features**:\n\n   - Average distance from parcel to 1, 3, and 5 nearest colleges and university buildings. Code written above in order to map feature.\n   \n3. **Census variables**:\n\n   - Join median income, percentage with a bachelor's degree, and poverty percentage \n\n4. **Interaction terms**:\n\n   - Wealthy neighborhoods which take into account if a home is in a wealthy neighborhood which is based on median sale price.\n   \n5. **Other features**:\n\n   - log_sale_price, log_livable_area, age and exterior condition (if it is good or not)\n\n\n**Feature Engineering Code**\n\n```{r feature engineering:buffer }\nparcel_proj <- parcel_proj %>% filter(!st_is_empty(.)) %>% st_make_valid()\n#Number of violent crimes in proximity \nparcel_buffers<- st_buffer(parcel_proj, dist=600)\n\nviolent_crimes <- c(\n  \"Homicide - Criminal\",\n  \"Aggravated Assault No Firearm\",\n  \"Robbery Firearm\",\n  \"Aggravated Assault Firearm\")\n\nviolent_proj <- crime_proj %>%\n  filter(text_gener %in% violent_crimes)\n    \nviolent_crime_counts <- st_intersects(parcel_buffers, violent_proj)\nviolent_crime_counts <- lengths(violent_crime_counts)\n\n#join by row numner\nparcel_data <- parcel_data %>%\n  mutate(violent_crime_600ft = violent_crime_counts[1:nrow(parcel_data)])\n\n\n\n```\n\n```{r}\n#relationship to age\nparcel_data <- parcel_data %>%\n  mutate(year_built = as.numeric(year_built))%>%\n  mutate(Age = 2025 - year_built)%>% filter(Age <2000)\n\n```\n\n```{r}\n\nparcel_data <- parcel_data %>%\n  filter(exterior_condition != 0) %>%\n  mutate(\n    exterior_good = case_when(\n      exterior_condition >= 1 & exterior_condition <= 5 ~ 1,\n      exterior_condition >= 6 & exterior_condition <= 9 ~ 0,\n      TRUE ~ NA_real_ \n    )\n  )\n\n\n```\n\n```{r interaction: as.factor}\n#interaction effects\nparcel_proj <- st_transform(parcel_data, 3365)\nneighborhood_proj <-st_transform(neighborhoods, 3365)\n\nparcel_with_neighborhood <-  st_join(parcel_proj, neighborhood_proj, join = st_within)%>%\n  st_drop_geometry()%>%\n  group_by(NAME) %>%\n  summarize(median_price = median(sale_price, na.rm = TRUE))\n\n\nwealthy_neighborhoods <- parcel_with_neighborhood%>%\n  filter(median_price >= 275500)%>%\n  pull(NAME)\n\n#changed wealthy_list to wealthy_neighborhoods because wealthy_list did not exist \nparcel_data <- parcel_proj %>%\n  st_join(neighborhood_proj, join = st_within) %>%\n  mutate(\n    wealthy_neighborhood = ifelse(NAME %in% wealthy_neighborhoods, \"Wealthy\", \"Not Wealthy\"),\n    wealthy_neighborhood = as.factor(wealthy_neighborhood)\n  )\nparcel_data <- parcel_data %>%\n  relocate(wealthy_neighborhood, .after = MAPNAME)\nView(st_drop_geometry(parcel_data))\n\n```\n\n\n```{r}\n#price vs. spatial features\n\nplot(parcel_data$violent_crime_600ft, parcel_data$sale_price)\nplot(parcel_data$college_nn1, parcel_data$sale_price)\nplot(parcel_data$wealthy_neighborhood, parcel_data$sale_price)\n\n```\n\n\nCreating Summary Table\n```{r}\n#Summary table of engineered features\n\n# Create a data frame summarizing each feature\nfeature_summary <- data.frame(\n  Feature_Name = c(\n    \"violent_crime_600ft\",\n    \"college_nn1\",\n    \"college_nn3\",\n    \"college_nn5\",\n    \"median_incomeE\",\n    \"percentage_bach\",\n    \"percentage_pov\",\n    \"wealthy_neighborhood\",\n    \"log_sale_price\",\n    \"log_livable_area\",\n    \"Age\",\n    \"exterior_good\"\n  ),\n  Feature_Type = c(\n    \"Buffer-based (spatial)\",\n    \"kNN (spatial distance)\",\n    \"kNN (spatial distance)\",\n    \"kNN (spatial distance)\",\n    \"Census (socioeconomic)\",\n    \"Census (education)\",\n    \"Census (poverty)\",\n    \"Interaction term (categorical)\",\n    \"Transformation (continuous)\",\n    \"Transformation (continuous)\",\n    \"Structural (numeric)\",\n    \"Condition (binary)\"\n  ),\n  Description = c(\n    \"Count of violent crimes within 600 ft of parcel\",\n    \"Average distance to nearest college/university (k=1)\",\n    \"Average distance to 3 nearest colleges/universities\",\n    \"Average distance to 5 nearest colleges/universities\",\n    \"Median household income of census tract\",\n    \"Percent of tract population with bachelor's degree\",\n    \"Percent of tract population below poverty line\",\n    \"Indicates parcels located in wealthy neighborhoods\",\n    \"Natural log of sale price\",\n    \"Natural log of total livable area (sq ft)\",\n    \"Years since building construction\",\n    \"1 = good/average exterior, 0 = poor\"\n  ),\n  Justification = c(\n    \"Captures neighborhood safety and crime exposure\",\n    \"Measures proximity to educational amenities\",\n    \"Captures local educational accessibility\",\n    \"Captures broader proximity to higher education hubs\",\n    \"Represents economic conditions of local area\",\n    \"Education level could be connected to property values\",\n    \"Reflects socioeconomic disadvantage\",\n    \"Identifies context of neighborhood wealth levels\",\n    \"Stabilizes variance for regression modeling\",\n    \"Normalizes skewed size variable for modeling\",\n    \"Accounts for how homes are desireable when they are historic but devalued when they are too old\",\n    \"Changed categorical condition to numeric to understand exterior desirability\"\n  )\n)\n\n# Print table nicely\nlibrary(knitr)\nkable(feature_summary, caption = \"Summary of Engineered Features\", align = \"l\")\n\n\n```\n\n**Justification:**\nThe features included were engineered to capture social, economic, and environmental factors influencing housing prices. Buffer-based and k nearest-neighbor measures quantify local accessibility and safety. Census data helps to enrich parcels with socio-economic context. Interaction terms account for neighborhood-level wealth which helps contextualize external features of a home, for instance homes in a wealthy neighborhood are more likely to have a higher property value than those in other neighborhood. Applying a binary indicator improves model interpretability and performance for the external condition of a property. The table above includes why each feature was chosen.\n\n\n\n### Phase 4: **Models**\n\n**Model progression:**\n\n1. Structural features only\n2. + Census variables\n3. + Spatial features\n4. + Interactions and fixed effects\n\n**For appendix:**\n\n```{r code and summary}\nmodel1 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good, data = parcel_data)\n\nsummary(model1)\n\nmodel2 <- lm(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov, data = parcel_data)\n\nsummary(model2)\n\nmodel3 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)\n\nsummary(model3)\n\nmodel4 <- lm(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft, data = parcel_data)\n\nsummary(model4)\n\nplot(fitted(model1), residuals(model1))\n\nplot(fitted(model2), residuals(model2))\n\nplot(fitted(model2), residuals(model2))\n\nplot(fitted(model3), residuals(model3))\n\n```\n\n***Coefficient interpretations:***\n\n\n### Phase 5: Model Validation\n\n```{r 10-fold cross-validation with scatter plots}\n\nparcel_data <- na.omit(parcel_data)\n\nctrl <- trainControl(\n  method = \"cv\",\n  number = 10  # 10-fold CV\n)\n\nmodel_cv1 <-  train(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area + garage_spaces + Age + I(Age^2) + exterior_good,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl)\n\nmodel_cv1\n  \nmodel_cv2 <- train(log_sale_price ~ number_of_bathrooms + number_of_bedrooms + log_livable_area  + garage_spaces + Age + I(Age^2) + exterior_good + median_incomeE + percentage_bach + percentage_pov,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl\n)\n\nmodel_cv2\n\nmodel_cv3 <- train(log_sale_price ~ number_of_bathrooms + garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area + median_incomeE + percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl\n)\n\nmodel_cv3\n\n\nmodel_cv4 <- train(log_sale_price ~ number_of_bathrooms+ garage_spaces + Age + I(Age^2) + exterior_good + log_livable_area * wealthy_neighborhood + median_incomeE +percentage_bach + percentage_pov + college_nn1 + violent_crime_600ft,\n  data = parcel_data,\n  method = \"lm\",\n  trControl = ctrl\n)\n\nmodel_cv4\n\n\n#Impact of each feature summary\nsummary(model_cv4$finalModel)\n\n```\n\n\n```{r predicted vs actual}\n\nlibrary(ggplot2)\n\nggplot(parcel_data, aes(x = predict(model_cv4$finalModel), y = log_sale_price)) +\n  geom_point(alpha = 0.3) +\n  geom_abline(slope = 1, intercept = 0, color = \"red\") +\n  labs(x = \"Predicted log(Sale Price)\", y = \"Actual log(Sale Price)\",\n       title = \"Predicted vs Actual Sale Prices\") +\n  theme_minimal()\n\n\n\n\n\n```\n\n\n**Discuss which features matter the most:**\nThe features which matter the most are wealthy neighborhoods, log of livable areas, percentage with a bachelor's degree and percentage of poverty. The First three features have a positive effect while the percentage of poverty has a strong inverse effect.\n\n### Phase 6: Model Diagnostics \n\n**Check assumptions for best model:**\n\n- Residual plot (linearity, homoscedasticity)\n- Q-Q plot (normality)\n- Cook's distance (influential observations)\n\n```{r residual plot, q-q plot, and cooks distance}\n\n# Residuals vs Fitted\nplot(\n  fitted(model_cv4),\n  residuals(model_cv4),\n  main = \"Residuals vs Fitted Values\",\n  xlab = \"Fitted Values (Predicted Log Sale Price)\",\n  ylab = \"Residuals\",\n  pch = 19,\n  col = \"darkblue\"\n)\nabline(h = 0, col = \"red\", lwd = 2, lty = 2)\n\n# Q-Q plot for normality\nqqnorm(residuals(model_cv4)); qqline(residuals(model_cv4))\n\n\n# Cook's distance for the final lm model\nplot(cooks.distance(model4), type=\"h\", main=\"Cook's Distance\")\n\n\n\n```\n\n**Interpretation of plots** \nThe Residuals vs Fitted plot is around 0 but slightly curved. This means that it could be missing a non-linear term. We tried accounting for this by squaring the age of the home. \n\nThe Q-Q Plot shows that the model roughly follows a normal distribution which means using a linear regression makes sense. Ultimately this provides more confidence in our model.\n\nCooks distance shows many spikes that are the same with a few all ones. A few tall spikes is not concerning as most of them are around the same height but the one on the right side of the graph could indicate a possible outlier that was not accounted for.\n\n\n\n### Phase 7: Conclusions & Recommendations\n\n\n```{r}\n#neighborhoods that are hardest to predict \nparcel_data$residuals <- residuals(model_cv4$finalModel)\nparcel_data %>%\n  group_by(LISTNAME) %>%\n  summarize(mean_abs_resid = mean(abs(residuals))) %>%\n  arrange(desc(mean_abs_resid))\n\n\n```\n\n**Detailed Discussion:**\nThe final model explains approximately 59% of the variation in housing prices across Philadelphia, indicating a moderately strong fit. The Mean Absolute Error (MAE) of 0.34 suggests that the model’s predictions are off by about 34%. The RMSE score means that predictions are abou $154,200 off the true sale price. This level of accuracy is reasonable given the complexity and variability of the housing market. The most influential predictors of housing prices include wealthy neighborhoods, log of livable areas, percentage with a bachelor's degree, all of which have strong positive effects on property values. Conversely, the percentage of poverty and proximity to crime have strong negative relationships with home prices, underscoring how social perceptions of safety influence property values.\n\nNeighborhoods that are the hardest to predict tend to be those undergoing rapid change or instability, particularly areas experiencing gentrification, high prevalence of vacant and distressed properties or smaller sample areas. Examples of this are Nicetown, Fairhill, and Upper Kensington which are all located in North Philadelphia. In fact the top 10 locations which are the most hard to predict are all in North Philadelphia. Areas experiencing gentrification, rising educational attainment and declining crime rates occur alongside persistent vacancy and poverty, leading to non-linear effects that standard models struggle to account for. The rapid transformation in these neighborhoods contributes to greater residual errors. Thus, the model performs best in **mid-range markets** and is less stable in low-value areas. \n\nFrom an equity perspective, including socioeconomic indicators such as poverty and education levels improves predictive accuracy but also risks reproducing structural inequalities. By learning from historical patterns of disinvestment, the model may undervalue properties in low-income or historically marginalized neighborhoods. This raises ethical concerns when creating policy based on automated valuation models as it could inadvertently reinforce existing disparities. To mitigate this, residual analysis can be used to test for spatial bias, identifying neighborhoods where the model systematically under- or over-predicts values. Recognizing the limitations within the model highlights opportunities to inform equitable housing policy, such as directing investment initiatives or development funds toward historically undervalued areas rather than further harming them through biased valuation tools. Limitations while creating this model were not cleaning the data in a way that removed abnormalities such as homes that sold for a lot more than those nearby when looking at square footage and not including transportation data which would enrich our understanding of the property's spatial features.\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"Final_Appendix.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.24","theme":"cosmo","title":"Philadelphia Housing Model Technical Appendix","author":"Ixchel Ramirez","date":"2025-10-27","toc-location":"left","document-css":false,"link-citations":true},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}