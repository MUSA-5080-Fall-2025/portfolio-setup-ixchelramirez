{"title":"Assignment 2: Spatial Analysis and Visualization","markdown":{"yaml":{"title":"Assignment 2: Spatial Analysis and Visualization","subtitle":"Healthcare Access and Equity in Pennsylvania","author":"Ixchel Ramirez","date":"October 19, 2025","format":{"html":{"code-fold":false,"toc":true,"toc-location":"left","theme":"cosmo","embed-resources":true}},"execute":{"warning":false,"message":false}},"headingText":"Part 1: Healthcare Access for Vulnerable Populations","containsRefs":false,"markdown":"\n\n\n### Research Question\n\n**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**\n\nYour analysis should identify counties that should be priorities for healthcare investment and policy intervention.\n\n### Required Analysis Steps\n\nComplete the following analysis, documenting each step with code and brief explanations:\n\n#### Step 1: Data Collection (5 points)\n\nLoad the required spatial data:\n- Pennsylvania county boundaries\n- Pennsylvania hospitals (from lecture data)\n- Pennsylvania census tracts\n\n**Set-up:**\n```{r}\n# Load required packages\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(tigris)\nlibrary(knitr)\nlibrary(sf)\nlibrary(dplyr)\n\n# Load spatial data\npa_counties <- st_read(\"C:/Users/ixche/Desktop/PPA/MUSA-5080-Fall-2025/lectures/week-04/data/Pennsylvania_County_Boundaries.shp\")\n\ncensus_tracts <- tracts(state = \"PA\", cb = TRUE, progress = FALSE)\nmetro_areas <- core_based_statistical_areas(cb = TRUE, progress = FALSE)\n# Read GeoJSON\ndistricts <- st_read(\"C:/Users/ixche/Desktop/PPA/MUSA-5080-Fall-2025/lectures/week-04/data/districts.geojson\")\nhospitals <- st_read(\"C:/Users/ixche/Desktop/PPA/MUSA-5080-Fall-2025/lectures/week-04/data/hospitals.geojson\")\n\n  \n# Check that all data loaded correctly\nst_geometry(pa_counties)\nst_geometry(hospitals)\n\nhospitals <- hospitals %>%\n  st_transform(st_crs(pa_counties))\ncensus_tracts <- census_tracts %>% \n  st_transform(st_crs(pa_counties))\ndistricts <- districts%>%\n  st_transform(st_crs(census_tracts))\n\nggplot(pa_counties) +\n  geom_sf() +\n  labs(title = \"PA Counties\") +\n  theme_void()\n\nggplot(census_tracts) +\n  geom_sf() +\n  labs(title = \"PA Census Tracts\") +\n  theme_void()\n\n\nggplot(districts) +\n  geom_sf() +\n  labs(title = \"PA districts\") +\n  theme_void()\n\nggplot(hospitals) +\n  geom_sf() +\n  labs(title = \"Hospitals\") +\n  theme_minimal()\n\n```\n\n**Questions to answer:**\n- How many hospitals are in your dataset? There are 223 hospitals in my dataset.\n- How many census tracts? There are 3445 census tracts in Pennsylvania.\n- What coordinate reference system is each dataset in? The pa_counties is is WGS 84 / Pseudo-Mercator which all datasets have been projeted to.\n\n---\n\n#### Step 2: Get Demographic Data \n\n**Required variables:**\n- Total population\n- Median household income\n- Population 65 years and over (you may need to sum multiple age categories)\n\n**Loading Demographic Data:**\n```{r}\n# Get demographic data from ACS\n\npa_vars <- c(\n  total_pop = \"B01001_001\",    # Total population\n  med_income = \"B19013_001\",   # Median household income\n  male_65_66 = \"B01001_020\",\n  male_67_69 = \"B01001_021\",\n  male_70_74 = \"B01001_022\",\n  male_75_79 = \"B01001_023\",\n  male_80_84 = \"B01001_024\",\n  male_85plus = \"B01001_025\",\n  female_65_66 = \"B01001_044\",\n  female_67_69 = \"B01001_045\",\n  female_70_74 = \"B01001_046\",\n  female_75_79 = \"B01001_047\",\n  female_80_84 = \"B01001_048\",\n  female_85plus = \"B01001_049\"\n)\n\npa_tracts_raw <- get_acs(\n  geography = \"tract\",\n  state = \"PA\",\n  variables = pa_vars,\n  year = 2022,\n  geometry = TRUE\n)\n\npa_tracts <- pa_tracts_raw %>%\n  select(GEOID, variable, estimate, geometry) %>%\n  pivot_wider(names_from = variable, values_from = estimate) %>%\n  mutate(\n    pop_65plus = male_65_66 + male_67_69 + male_70_74 + male_75_79 + male_80_84 + male_85plus +\n                 female_65_66 + female_67_69 + female_70_74 + female_75_79 + female_80_84 + female_85plus,\n    pct_65plus = 100 * pop_65plus / total_pop\n  ) %>%\n  st_as_sf()\n\n\nglimpse(pa_tracts)\nsummary(pa_tracts$med_income)\nsummary(pa_tracts$pct_65plus)\n\n# Join to tract boundaries\n\n\nsum(is.na(pa_tracts$med_income))\nmedian(pa_tracts$med_income, na.rm = TRUE)\n\n```\n\n**Questions to answer:**\n- What year of ACS data are you using? I am using **2022 5 Year Estimates ACS data**\n- How many tracts have missing income data? **63** tracts have missing median income data.\n- What is the median income across all PA census tracts? The median income accross PA census tracts is **\\$70,188**.\n\n---\n\n#### Step 3: Define Vulnerable Populations \n\nIdentify census tracts with vulnerable populations based on TWO criteria:\n1. Low median household income (choose an appropriate threshold)\n2. Significant elderly population (choose an appropriate threshold)\n\n**Finding Vulnerable Tracts:**\n```{r}\n# Filter for vulnerable tracts based on your criteria\n\nincome_threshold <- 56000\nelderly_threshold <- 0.25 \n\ncat(\"Income threshold (fixed):\", income_threshold, \"\\n\")\ncat(\"Elderly threshold (fixed):\", elderly_threshold, \"%\\n\")\n\n# Classify tracts based on both criteria\npa_tracts_vulnerable <- pa_tracts %>%\n  mutate(\n    low_income = med_income <= income_threshold,\n    high_elderly = pct_65plus >= elderly_threshold,\n    vulnerable = if_else(low_income & high_elderly, TRUE, FALSE)\n  )\n\n# Count how many tracts meet each condition\npa_tracts_vulnerable %>%\n  st_drop_geometry() %>%\n  summarise(\n    n_low_income = sum(low_income, na.rm = TRUE),\n    n_high_elderly = sum(high_elderly, na.rm = TRUE),\n    n_vulnerable = sum(vulnerable, na.rm = TRUE)\n  )\n\n\n\n```\n\n**Questions to answer:**\n- What income threshold did you choose and why? \nI used **$56000** as the threshold for income because it is about twenty percent below the median income.\n- What elderly population threshold did you choose and why? \nI defined the elderly population threshold as areas with more than 25% of residents who are elderly as this is a significant population within a community who would benefit from being near a hospital even through it is less than a majority.  \n- How many tracts meet your vulnerability criteria?\n850 tracts meet this vulnerability criteria (both thresholds).\n- What percentage of PA census tracts are considered vulnerable by your definition?\nThe percentage of vulnerable PA census tracts is **24.67%**.\n---\n\n#### Step 4: Calculate Distance to Hospitals \n\nFor each vulnerable tract, calculate the distance to the nearest hospital.\n\n**Your Task:**\n```{r}\n# Use projected CRS in feet\ntarget_crs <- 2272  # Pennsylvania South (ft)\npa_tracts_vulnerable_proj <- st_transform(pa_tracts_vulnerable, target_crs)\nhospitals_proj <- st_transform(hospitals, target_crs)\n\n# Compute centroids of vulnerable tracts\ntract_vuln <- st_centroid(pa_tracts_vulnerable_proj) %>% filter(vulnerable)\n\n# Find nearest hospital for each vulnerable tract\nnearest_hospital_index <- st_nearest_feature(tract_vuln, hospitals_proj)\nnearest_hospitals <- hospitals_proj[nearest_hospital_index, ]\n\n# Compute distances in feet, convert to miles\ndist_ft <- st_distance(tract_vuln, nearest_hospitals, by_element = TRUE)\ntract_vuln$dist_to_hospital_miles <- as.numeric(dist_ft) / 5280\n\n# Summarize distances\navg_dist <- mean(tract_vuln$dist_to_hospital_miles, na.rm = TRUE)\nmax_dist <- max(tract_vuln$dist_to_hospital_miles, na.rm = TRUE)\nover15 <- sum(tract_vuln$dist_to_hospital_miles > 15, na.rm = TRUE)\n\ncat(\"Average distance to nearest hospital (miles):\", round(avg_dist, 2), \"\\n\")\ncat(\"Maximum distance (miles):\", round(max_dist, 2), \"\\n\")\ncat(\"Number of vulnerable tracts >15 miles from nearest hospital:\", over15, \"\\n\")\n\n\n```\n\n**Requirements:**\n- Projections and Calculating distances in miles\nI used Pennsylvania South projection so I could convert feet to miles. \n\n**Questions to answer:**\n- What is the average distance to the nearest hospital for vulnerable tracts?  3.1 miles\n- What is the maximum distance? The maximum distance is 25.62 miles.\n- How many vulnerable tracts are more than 15 miles from the nearest hospital? There are 22 vulnerable tracts that are more than 15 miles from the nearest hospital.\n\n---\n\n#### Step 5: Identify Underserved Areas \n\nDefine \"underserved\" as vulnerable tracts that are more than 15 miles from the nearest hospital.\n\n**Your Task:**\n```{r}\n# Create underserved variable\ntract_vuln <- tract_vuln %>%\n  mutate(\n    underserved = dist_to_hospital_miles > 15\n  )\n\nnum_underserved <- sum(tract_vuln$underserved, na.rm = TRUE)\ntotal_vulnerable <- nrow(tract_vuln)\npct_underserved <- (num_underserved / total_vulnerable) * 100\n\n```\n\n**Questions to answer:**\n- How many tracts are underserved? 22 are underserved\n- What percentage of vulnerable tracts are underserved? 2.60% of vulnerable tracts are underserved\n- Does this surprise you? Why or why not? I am pleasantly surprised that there is not a higher percentage of vulnerable tracts that are underserved especially with regards to income being a factor as this limits where one can live. \n---\n\n#### Step 6: Aggregate to County Level\n\nUse spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.\n\n**Your Task:**\n```{r}\n# Spatial join tracts to counties\npa_counties_proj <- st_transform(pa_counties, st_crs(tract_vuln))\n\ntracts_county <- st_join(\n  tract_vuln,\n  pa_counties_proj %>% select(COUNTY_NAM),\n  join = st_within\n)\n\n# Aggregate statistics by county\n\ncounty_stats <- tracts_county %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarise(\n    n_vulnerable_tracts = n(),\n    n_underserved_tracts = sum(underserved, na.rm = TRUE),\n    pct_underserved = 100 * n_underserved_tracts / n_vulnerable_tracts,\n    avg_dist_miles = mean(dist_to_hospital_miles, na.rm = TRUE),\n    total_vulnerable_pop = sum(pop_65plus, na.rm = TRUE)\n  ) %>%\n  arrange(desc(pct_underserved))\n\ntop5_pct_underserved <- county_stats %>%\n  slice_max(pct_underserved, n = 5) %>%\n  select(COUNTY_NAM, pct_underserved, n_vulnerable_tracts, n_underserved_tracts)\n\ntop5_pct_underserved\n\n# View top 5 counties by total vulnerable population\ntop5_vulnerable_pop <- county_stats %>%\n  slice_max(total_vulnerable_pop, n = 5) %>%\n  select(COUNTY_NAM, total_vulnerable_pop, n_underserved_tracts)\n\ntop5_vulnerable_pop\n\n```\nUse spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.\n\n**Your Task:**\n```{r}\n#Spatial Understanding of where vulnerable counties are \n\npa_counties_proj <- st_transform(pa_counties, st_crs(tract_vuln))\n\ntracts_county <- st_join(\n  tract_vuln,\n  pa_counties_proj %>% select(COUNTY_NAM),\n  join = st_within\n)\n\n# Convert underserved to numeric so sum() works\ntracts_county <- tracts_county %>%\n  mutate(underserved_num = ifelse(underserved, 1, 0))\n\n# Aggregate statistics by county\ncounty_stats <- tracts_county %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarise(\n    n_vulnerable_tracts = n(),\n    n_underserved_tracts = sum(underserved_num, na.rm = TRUE),\n    pct_underserved = 100 * n_underserved_tracts / n_vulnerable_tracts,\n    avg_dist_miles = mean(dist_to_hospital_miles, na.rm = TRUE),\n    total_vulnerable_pop = sum(pop_65plus, na.rm = TRUE)\n  ) %>%\n  arrange(desc(pct_underserved))\n\n# View top 5 counties by pct underserved\ntop5_pct_underserved <- county_stats %>%\n  slice_max(pct_underserved, n = 5) %>%\n  select(COUNTY_NAM, pct_underserved, n_vulnerable_tracts, n_underserved_tracts)\n\ntop5_pct_underserved\n\n\n#to understand spatial patterns\nlibrary(ggplot2)\n\npa_counties_plot <- pa_counties_proj %>%\n  left_join(county_stats, by = \"COUNTY_NAM\")\n\n# Map: percent of vulnerable tracts that are underserved\nggplot(pa_counties_plot) +\n  geom_sf(aes(fill = pct_underserved), color = \"white\") +\n  scale_fill_viridis_c(option = \"magma\", direction = -1, \n                       na.value = \"grey90\", name = \"% Underserved\") +\n  labs(\n    title = \"Percent of Vulnerable Counties Underserved by Hospitals\",\n    subtitle = \"Pennsylvania Counties\",\n    caption = \"Data: Vulnerable tracts (>65+ elderly & low income) & hospital locations\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12)\n  )\n\n\n```\n\n\n\n**Required county-level statistics:**\n- Number of vulnerable tracts\n- Number of underserved tracts  \n- Percentage of vulnerable tracts that are underserved\n- Average distance to nearest hospital for vulnerable tracts\n- Total vulnerable population\n\n**Questions to answer:**\n- Which 5 counties have the highest percentage of underserved vulnerable tracts? \nCAMERON\t\t\nFOREST\t\t\nSULLIVAN\t\t\nMONROE\t\t\nJUNIATA\t\t\nPOTTER\n\n- Which counties have the most vulnerable people living far from hospitals?\nThe counties with the most vulnerable people living far from hospitals are:\nPHILADELPHIA\t\t\nALLEGHENY\t\t\nLUZERNE\t\t\nFAYETTE\t\nWESTMORELAND\n\n- Are there any patterns in where underserved counties are located?\nThe underserved counties are mainly in the northern half of the state  \n---\n\n#### Step 7: Create Summary Table \n\nCreate a professional table showing the top 10 priority counties for healthcare investment.\n\n**Your Task:**\n```{r}\n# Create and format priority counties table\ncounty_stats_2 <- county_stats %>%\n  mutate(\n    priority_score = n_vulnerable_tracts * 0.6 + total_vulnerable_pop * 0.4  # example weighting\n  )\n\nlibrary(scales)\n\n# Select top 10 priority counties\ntop10_priority <- county_stats_2 %>%\n  arrange(desc(priority_score)) %>%\n  slice(1:10) %>%\n  select(\n    County = COUNTY_NAM,\n    `Vulnerable & Remote Tracts` = n_vulnerable_tracts,\n    `Total Vulnerable Population` = total_vulnerable_pop,\n    `Priority Score` = priority_score\n  ) %>%\n  mutate(\n    `Total Vulnerable Population` = comma(`Total Vulnerable Population`),\n    `Priority Score` = round(`Priority Score`, 1)\n  )\n\n\n# Display professional table\nkable(\n  top10_priority,\n  caption = \"Top 10 Priority Counties for Healthcare Investment in Pennsylvania\",\n  align = c(\"l\", \"c\", \"c\", \"c\"),\n  digits = 0\n)\n\n\n```\n\n\n---\n\n## Part 2: Comprehensive Visualization \n### Map 1: County-Level Choropleth \n\nCreate a choropleth map showing healthcare access challenges at the county level.\n\n**Your Task:**\n```{r}\n# Create county-level access map\n\nlibrary(viridis)\n\n# Merge county statistics back to county geometries\npa_counties_plot <- pa_counties_proj %>%\n  left_join(county_stats_2, by = c(\"COUNTY_NAM\"))\n\n# Map: percent of vulnerable tracts underserved with hospital locations\nggplot(pa_counties_plot) +\n  # Counties filled by percent underserved\n  geom_sf(aes(fill = pct_underserved), color = \"transparent\") +\n  \n  # Hospitals as points\n  geom_sf(data = hospitals_proj, color = \"red\", size = 2, shape = 21, fill = \"red\") +\n  \n  # Color scale\n  scale_fill_viridis_c(\n    option = \"Blues\",\n    direction = -1,\n    na.value = \"grey80\",\n    name = \"% Vulnerable Tracts Underserved\"\n  ) +\n  \n  # Titles and caption\n  labs(\n    title = \"Healthcare Access Challenges Across Pennsylvania Counties\",\n    subtitle = \"Percent of vulnerable tracts underserved by hospitals (>15 miles away)\",\n    caption = \"Data Sources: ACS 2022, Pennsylvania Hospitals\"\n  ) +\n  \n  # Clean theme\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12),\n    plot.caption = element_text(size = 9),\n    legend.position = \"right\"\n  )\n\n\n```\n\n\n\n---\n\n### Map 2: Detailed Vulnerability Map \n\nCreate a map highlighting underserved vulnerable tracts.\n\n**Your Task:**\n```{r}\n\n# Create distribution visualization\n### Map 2: Detailed Vulnerability Map (Robust Version)\ntract_vuln <- tract_vuln %>% \n  filter(!st_is_empty(geometry)) %>% \n  st_make_valid()\n\npa_counties_proj <- pa_counties_proj %>%\n  filter(!st_is_empty(geometry)) %>%\n  st_make_valid()\n\nhospitals_proj <- hospitals_proj %>%\n  filter(!st_is_empty(geometry)) %>%\n  st_make_valid()\n\ntracts_vulnerable_only <- tract_vuln %>% \n  filter(vulnerable == TRUE) %>%\n  st_as_sf()\n\ntracts_underserved <- tract_vuln %>% \n  filter(underserved == TRUE) %>%\n  st_as_sf()\n\n\nst_is_valid(tracts_vulnerable_only) %>% table()\ntracts_vulnerable_only <- tracts_vulnerable_only %>%\n  filter(!st_is_empty(geometry), !is.na(st_dimension(geometry)))\nnrow(tracts_vulnerable_only)\nsum(st_is_empty(tracts_vulnerable_only))\n\nclass(tracts_vulnerable_only)\nst_geometry(tracts_vulnerable_only)\n#trial plot\n\nst_geometry(census_tracts)\n\ntracts_vulnerable_only <- census_tracts %>%\n  left_join(tracts_vulnerable_only %>% st_drop_geometry(), by = \"GEOID\") %>%\n  filter(vulnerable == TRUE)\n\n#refinement\ntracts_vulnerable_only <- tracts_vulnerable_only %>%\n  mutate(category = case_when(\n    underserved == TRUE ~ \"Underserved\",\n    vulnerable == TRUE ~ \"Vulnerable\",\n    TRUE ~ \"Other\"\n  ))\n\n\nggplot() +\n  geom_sf(data = pa_counties_proj, fill = \"grey95\", color = \"darkgrey\", size = 0.2) +\n  geom_sf(data = tracts_vulnerable_only, aes(fill = category), color = NA, alpha = 0.7) +\n  geom_sf(data = hospitals_proj, color = \"grey18\", fill = \"grey22\", shape = 21, size = 1) +\n  scale_fill_manual(\n    values = c(\n      \"Underserved\" = \"red\",\n      \"Vulnerable\" = \"firebrick4\",\n      \"Other\" = \"grey90\"\n    ),\n    name = \"Tract Category\"\n  ) +\n  labs(\n    title = \"Underserved and Vulnerable Populations in Pennsylvania\",\n    subtitle = \"Census tracts with elderly + low-income residents more than 15 miles from a hospital\",\n    caption = \"Data: ACS 2022, Pennsylvania Hospitals\"\n  ) +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12),\n    legend.position = \"bottom\",\n    legend.title = element_text(face = \"bold\"),\n    panel.grid = element_blank() \n  )\n\n\n```\n\n\n\n**Requirements:**\nI used a bright red to distinguish underserved vulnerable tracts, which are easy to see in contrast to the other tracts and the hospitals which are all darker tones. \n\n---\n\n### Chart: Distribution Analysis\n\nCreate a visualization showing the distribution of distances to hospitals for vulnerable populations.\n\n**Your Task:**\n```{r}\n# Create distribution visualization\n\nggplot(tract_vuln, aes(x = dist_to_hospital_miles)) +\n  geom_histogram(binwidth = 2, fill = \"steelblue\", color = \"white\", alpha = 0.8) +\n  geom_vline(xintercept = 15, linetype = \"dashed\", color = \"red\", size = 1) +\n  labs(\n    title = \"Distribution of Distances to Nearest Hospital (Vulnerable Tracts)\",\n    x = \"Distance to Nearest Hospital (miles)\",\n    y = \"Number of Vulnerable Tracts\",\n    caption = \"Dashed line = 15-mile underserved threshold\"\n  ) +\n  theme_minimal()\n\n\n\n\n```\n\n**Requirements:**\n- Brief interpretation \nMost vulnerable tracts are within a 15 miles of a hospital, a small portion of them are further than 15 miles from a hospital.\n\n---\n\n## Part 3: Bring Your Own Data Analysis \n\n### Challenge Options\n\n### Your Analysis\n\n**Your Task:**\n\n**Option B: School Safety Zones**\n- **Data:** Schools, Crime Incidents, Bike Network\n- **Question:** \"Are school zones safe for walking/biking, or are they crime hotspots?\"\n- **Operations:** Buffer schools (1000ft safety zone), spatial join with crime incidents, assess bike infrastructure coverage\n- **Policy relevance:** Safe Routes to School programs, crossing guard placement\n\n\n1. All three data sets come from **OpenDataPhilly:** https://opendataphilly.org/datasets/\n**Find and load additional data**\n   - Document your data source\n   - Check and standardize the CRS\n   - Provide basic summary statistics\n\n```{r}\n# Load your additional dataset\n\nschools <- st_read(\"C:/Users/ixche/Desktop/PPA/Working Files/lab_2/Schools.geojson\")\ncrime <- st_read(\"C:/Users/ixche/Desktop/PPA/Working Files/lab_2/incidents_part1_part2 (2)/incidents_part1_part2.shp\")\nbikenetwork <- st_read(\"C:/Users/ixche/Desktop/PPA/Working Files/lab_2/Bike_Network.geojson\")\n\ntarget_crs <- st_crs(2272)\nschools <- st_transform(schools, target_crs)\ncrime <- st_transform(crime, target_crs)\nbikenetwork <- st_transform(bikenetwork, target_crs)\n\nsummary(schools)\nsummary(crime)\nsummary(bikenetwork)\n```\n\n**Questions to answer:**\n- What dataset did you choose and why?\nThe datasets I used are Crime Incidents, Bike Network and Schools from OpenDataPhilly.\n\n- What is the data source and date?\nThe data source is OpenDataPhilly and it was accessed on October 19.\n\n- How many features does it contain?\nBikenetwork contains 9 variables, crime contains 14 variables and schools contains 15 variables.\n\n- What CRS is it in? Did you need to transform it?\nThe CRS was WGS 84, I transformed it for additional practice but they were all in the same coordinate reference system.\n---\n\n2. **Pose a research question**\nAre school zones safe for walking/biking, or are they crime hotspots?\n\n---\n\n3. **Conduct spatial analysis**\n\nI am using buffers and spatial joins to complete my analysis. \n\n**Your Task: Setting up the Data**\n```{r}\n# Your spatial analysis\n\nschool_buffers <- st_buffer(schools, dist = 1000)  # creates a 1000 ft safety zone around schools\n\nschool_buffers <- school_buffers %>%\n  rename(school_id = objectid) #rename the school ids so the columns have different names\n\ncrime <- crime %>%\n  rename(crime_id = objectid)\nschool_crime_counts <- st_join(school_buffers, crime, join = st_contains) %>%\n  group_by(school_id, school_name) %>%  # Use unique school ID\n  summarise(\n    n_crimes = n(),\n    .groups = \"drop\"\n  )\n\n#including the coverage of the bike network in Philly\nbike_in_buffers <- st_intersection(bikenetwork, school_buffers)\n\nbike_length_per_school <- bike_in_buffers %>%\n  group_by(school_id, school_name) %>%\n  summarise(\n    bike_length_ft = sum(st_length(geometry)),\n    .groups = \"drop\"\n  )\n\n#Bringing all the data together\n# Drop geometry for bike summary\nbike_length_per_school_df <- bike_length_per_school %>%\n  st_drop_geometry()\n\n# Now join safely\nschool_safety_summary <- school_crime_counts %>%\n  left_join(bike_length_per_school_df, by = c(\"school_id\", \"school_name\")) %>%\n  mutate(bike_length_ft = ifelse(is.na(bike_length_ft), 0, bike_length_ft))\n\n#Map of findings\nlibrary(ggplot2)\nlibrary(scales)\n\nschool_crime_counts_df <- st_drop_geometry(school_crime_counts)\n\n# Merge crime counts to school buffers for plotting\nschool_buffers_plot <- school_buffers %>%\n  left_join(school_crime_counts_df, by = c(\"school_id\", \"school_name\"))\n\nschool_buffers_plot <- school_buffers_plot %>%\n  mutate(n_crimes = ifelse(is.na(n_crimes), 0, n_crimes))\n\n# Highlight variation (e.g., sqrt)\nschool_buffers_plot <- school_buffers_plot %>%\n  mutate(n_crimes_sqrt = sqrt(n_crimes))\n\n```\n\n**Mapping**\n```{r}\n# Your spatial analysis\n\nggplot(school_buffers_plot) +\n  geom_sf(aes(fill = n_crimes), color = NA) +\n  scale_fill_viridis_c(option = \"inferno\", name = \"Crime Count\") +\n  labs(\n    title = \"Philadelphia School Safety Zones\",\n    subtitle = \"Crime incidents within 1000 ft of schools\",\n    caption = \"Source: OpenDataPhilly (2025)\"\n  ) +\n  theme_void() +\n  theme(\n    legend.position = \"right\",\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12)\n  )\n\n\n# Ensure both layers have the same CRS\nbikenetwork <- st_transform(bikenetwork, st_crs(school_buffers_plot))\n\n# --- 1. Intersect bike network with school buffers ---\n# This keeps only the bike segments that fall within 1000 ft of schools\nbike_in_buffers <- st_intersection(bikenetwork, school_buffers_plot)\n\n# --- 2. Map: Crime gradient + bike network inside buffers ---\nggplot() +\n  # School buffer polygons shaded by number of crimes\n  geom_sf(data = school_buffers_plot, aes(fill = n_crimes), color = NA) +\n  \n  # Bike network segments within buffers (cyan lines)\n  geom_sf(\n    data = bike_in_buffers,\n    color = \"cyan3\",\n    size = 0.6,\n    alpha = 0.8\n  ) +\n  \n  # Color scale for crime density\n  scale_fill_viridis_c(option = \"inferno\", name = \"Crime Count\") +\n  \n  # Titles and labels\n  labs(\n    title = \"Philadelphia School Safety Zones and Bike Network Coverage\",\n    subtitle = \"Bike network segments within 1000 ft of schools overlaid on crime density\",\n    caption = \"Source: OpenDataPhilly (2025)\"\n  ) +\n  \n  # Minimal map style\n  theme_void() +\n  theme(\n    legend.position = \"right\",\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12)\n  )\n\n\n```\n\n**Summary Statistics and Counts**\n```{r}\n# Summary Statistics for School Safety Analysis\n\n# 1. Total number of schools analyzed\nn_schools <- nrow(school_crime_counts)\n\n# 2. Total number of crimes within 1000 ft of schools\ntotal_crimes <- sum(school_crime_counts$n_crimes, na.rm = TRUE)\n\n# 3. Average number of crimes per school buffer\navg_crimes_per_school <- mean(school_crime_counts$n_crimes, na.rm = TRUE)\n\n# 4. Number (and percent) of schools with *zero* nearby crimes\nschools_no_crime <- sum(school_crime_counts$n_crimes == 0, na.rm = TRUE)\npct_no_crime <- round(100 * schools_no_crime / n_schools, 1)\n\n# 5. Bike network coverage summary\ntotal_bike_length <- sum(bike_length_per_school$bike_length_ft, na.rm = TRUE)\navg_bike_length <- mean(bike_length_per_school$bike_length_ft, na.rm = TRUE)\n\n#simple summary table\nsummary_table <- data.frame(\n  Metric = c(\n    \"Total schools analyzed\",\n    \"Total crimes within 1000 ft\",\n    \"Average crimes per school\",\n    \"Schools with no nearby crimes\",\n    \"Percent of schools with no nearby crimes\",\n    \"Total bike network length within 1000 ft (ft)\",\n    \"Average bike network length per school (ft)\"\n  ),\n  Value = c(\n    n_schools,\n    total_crimes,\n    round(avg_crimes_per_school, 1),\n    schools_no_crime,\n    paste0(pct_no_crime, \"%\"),\n    round(total_bike_length, 0),\n    round(avg_bike_length, 0)\n  )\n)\n\n# Display the table nicely\nlibrary(knitr)\nkable(summary_table, caption = \"Summary of School Zone Safety and Bike Access in Philadelphia\")\n\n\n\n```\n\n**Analysis requirements:**\n- Clear code comments explaining each step\n- Appropriate CRS transformations\n- Summary statistics or counts\n- At least one map showing your findings\n- Brief interpretation of results (3-5 sentences)\n\n**Your interpretation:**\nSchool zones are generally safe for biking and walking. Only 3 of the points in the 1000ft of school buffers have a 1000 or more crime incidents. The average number of crimes per school is 177 which is 0.14% of the crimes in Philadelphia. Since Philadelphia has 495 located throughout the city, this accounts for the high number for total crimes within 1000 feet of a school, which means it is more helpful to look at general trends of crime per school than this number alone.\n\n\n## Finally - A few comments about your incorporation of feedback!\nI deleted additional instructions and added additional headers to help with readability. \n\n\n","srcMarkdownNoYaml":"\n\n## Part 1: Healthcare Access for Vulnerable Populations\n\n### Research Question\n\n**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**\n\nYour analysis should identify counties that should be priorities for healthcare investment and policy intervention.\n\n### Required Analysis Steps\n\nComplete the following analysis, documenting each step with code and brief explanations:\n\n#### Step 1: Data Collection (5 points)\n\nLoad the required spatial data:\n- Pennsylvania county boundaries\n- Pennsylvania hospitals (from lecture data)\n- Pennsylvania census tracts\n\n**Set-up:**\n```{r}\n# Load required packages\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(tigris)\nlibrary(knitr)\nlibrary(sf)\nlibrary(dplyr)\n\n# Load spatial data\npa_counties <- st_read(\"C:/Users/ixche/Desktop/PPA/MUSA-5080-Fall-2025/lectures/week-04/data/Pennsylvania_County_Boundaries.shp\")\n\ncensus_tracts <- tracts(state = \"PA\", cb = TRUE, progress = FALSE)\nmetro_areas <- core_based_statistical_areas(cb = TRUE, progress = FALSE)\n# Read GeoJSON\ndistricts <- st_read(\"C:/Users/ixche/Desktop/PPA/MUSA-5080-Fall-2025/lectures/week-04/data/districts.geojson\")\nhospitals <- st_read(\"C:/Users/ixche/Desktop/PPA/MUSA-5080-Fall-2025/lectures/week-04/data/hospitals.geojson\")\n\n  \n# Check that all data loaded correctly\nst_geometry(pa_counties)\nst_geometry(hospitals)\n\nhospitals <- hospitals %>%\n  st_transform(st_crs(pa_counties))\ncensus_tracts <- census_tracts %>% \n  st_transform(st_crs(pa_counties))\ndistricts <- districts%>%\n  st_transform(st_crs(census_tracts))\n\nggplot(pa_counties) +\n  geom_sf() +\n  labs(title = \"PA Counties\") +\n  theme_void()\n\nggplot(census_tracts) +\n  geom_sf() +\n  labs(title = \"PA Census Tracts\") +\n  theme_void()\n\n\nggplot(districts) +\n  geom_sf() +\n  labs(title = \"PA districts\") +\n  theme_void()\n\nggplot(hospitals) +\n  geom_sf() +\n  labs(title = \"Hospitals\") +\n  theme_minimal()\n\n```\n\n**Questions to answer:**\n- How many hospitals are in your dataset? There are 223 hospitals in my dataset.\n- How many census tracts? There are 3445 census tracts in Pennsylvania.\n- What coordinate reference system is each dataset in? The pa_counties is is WGS 84 / Pseudo-Mercator which all datasets have been projeted to.\n\n---\n\n#### Step 2: Get Demographic Data \n\n**Required variables:**\n- Total population\n- Median household income\n- Population 65 years and over (you may need to sum multiple age categories)\n\n**Loading Demographic Data:**\n```{r}\n# Get demographic data from ACS\n\npa_vars <- c(\n  total_pop = \"B01001_001\",    # Total population\n  med_income = \"B19013_001\",   # Median household income\n  male_65_66 = \"B01001_020\",\n  male_67_69 = \"B01001_021\",\n  male_70_74 = \"B01001_022\",\n  male_75_79 = \"B01001_023\",\n  male_80_84 = \"B01001_024\",\n  male_85plus = \"B01001_025\",\n  female_65_66 = \"B01001_044\",\n  female_67_69 = \"B01001_045\",\n  female_70_74 = \"B01001_046\",\n  female_75_79 = \"B01001_047\",\n  female_80_84 = \"B01001_048\",\n  female_85plus = \"B01001_049\"\n)\n\npa_tracts_raw <- get_acs(\n  geography = \"tract\",\n  state = \"PA\",\n  variables = pa_vars,\n  year = 2022,\n  geometry = TRUE\n)\n\npa_tracts <- pa_tracts_raw %>%\n  select(GEOID, variable, estimate, geometry) %>%\n  pivot_wider(names_from = variable, values_from = estimate) %>%\n  mutate(\n    pop_65plus = male_65_66 + male_67_69 + male_70_74 + male_75_79 + male_80_84 + male_85plus +\n                 female_65_66 + female_67_69 + female_70_74 + female_75_79 + female_80_84 + female_85plus,\n    pct_65plus = 100 * pop_65plus / total_pop\n  ) %>%\n  st_as_sf()\n\n\nglimpse(pa_tracts)\nsummary(pa_tracts$med_income)\nsummary(pa_tracts$pct_65plus)\n\n# Join to tract boundaries\n\n\nsum(is.na(pa_tracts$med_income))\nmedian(pa_tracts$med_income, na.rm = TRUE)\n\n```\n\n**Questions to answer:**\n- What year of ACS data are you using? I am using **2022 5 Year Estimates ACS data**\n- How many tracts have missing income data? **63** tracts have missing median income data.\n- What is the median income across all PA census tracts? The median income accross PA census tracts is **\\$70,188**.\n\n---\n\n#### Step 3: Define Vulnerable Populations \n\nIdentify census tracts with vulnerable populations based on TWO criteria:\n1. Low median household income (choose an appropriate threshold)\n2. Significant elderly population (choose an appropriate threshold)\n\n**Finding Vulnerable Tracts:**\n```{r}\n# Filter for vulnerable tracts based on your criteria\n\nincome_threshold <- 56000\nelderly_threshold <- 0.25 \n\ncat(\"Income threshold (fixed):\", income_threshold, \"\\n\")\ncat(\"Elderly threshold (fixed):\", elderly_threshold, \"%\\n\")\n\n# Classify tracts based on both criteria\npa_tracts_vulnerable <- pa_tracts %>%\n  mutate(\n    low_income = med_income <= income_threshold,\n    high_elderly = pct_65plus >= elderly_threshold,\n    vulnerable = if_else(low_income & high_elderly, TRUE, FALSE)\n  )\n\n# Count how many tracts meet each condition\npa_tracts_vulnerable %>%\n  st_drop_geometry() %>%\n  summarise(\n    n_low_income = sum(low_income, na.rm = TRUE),\n    n_high_elderly = sum(high_elderly, na.rm = TRUE),\n    n_vulnerable = sum(vulnerable, na.rm = TRUE)\n  )\n\n\n\n```\n\n**Questions to answer:**\n- What income threshold did you choose and why? \nI used **$56000** as the threshold for income because it is about twenty percent below the median income.\n- What elderly population threshold did you choose and why? \nI defined the elderly population threshold as areas with more than 25% of residents who are elderly as this is a significant population within a community who would benefit from being near a hospital even through it is less than a majority.  \n- How many tracts meet your vulnerability criteria?\n850 tracts meet this vulnerability criteria (both thresholds).\n- What percentage of PA census tracts are considered vulnerable by your definition?\nThe percentage of vulnerable PA census tracts is **24.67%**.\n---\n\n#### Step 4: Calculate Distance to Hospitals \n\nFor each vulnerable tract, calculate the distance to the nearest hospital.\n\n**Your Task:**\n```{r}\n# Use projected CRS in feet\ntarget_crs <- 2272  # Pennsylvania South (ft)\npa_tracts_vulnerable_proj <- st_transform(pa_tracts_vulnerable, target_crs)\nhospitals_proj <- st_transform(hospitals, target_crs)\n\n# Compute centroids of vulnerable tracts\ntract_vuln <- st_centroid(pa_tracts_vulnerable_proj) %>% filter(vulnerable)\n\n# Find nearest hospital for each vulnerable tract\nnearest_hospital_index <- st_nearest_feature(tract_vuln, hospitals_proj)\nnearest_hospitals <- hospitals_proj[nearest_hospital_index, ]\n\n# Compute distances in feet, convert to miles\ndist_ft <- st_distance(tract_vuln, nearest_hospitals, by_element = TRUE)\ntract_vuln$dist_to_hospital_miles <- as.numeric(dist_ft) / 5280\n\n# Summarize distances\navg_dist <- mean(tract_vuln$dist_to_hospital_miles, na.rm = TRUE)\nmax_dist <- max(tract_vuln$dist_to_hospital_miles, na.rm = TRUE)\nover15 <- sum(tract_vuln$dist_to_hospital_miles > 15, na.rm = TRUE)\n\ncat(\"Average distance to nearest hospital (miles):\", round(avg_dist, 2), \"\\n\")\ncat(\"Maximum distance (miles):\", round(max_dist, 2), \"\\n\")\ncat(\"Number of vulnerable tracts >15 miles from nearest hospital:\", over15, \"\\n\")\n\n\n```\n\n**Requirements:**\n- Projections and Calculating distances in miles\nI used Pennsylvania South projection so I could convert feet to miles. \n\n**Questions to answer:**\n- What is the average distance to the nearest hospital for vulnerable tracts?  3.1 miles\n- What is the maximum distance? The maximum distance is 25.62 miles.\n- How many vulnerable tracts are more than 15 miles from the nearest hospital? There are 22 vulnerable tracts that are more than 15 miles from the nearest hospital.\n\n---\n\n#### Step 5: Identify Underserved Areas \n\nDefine \"underserved\" as vulnerable tracts that are more than 15 miles from the nearest hospital.\n\n**Your Task:**\n```{r}\n# Create underserved variable\ntract_vuln <- tract_vuln %>%\n  mutate(\n    underserved = dist_to_hospital_miles > 15\n  )\n\nnum_underserved <- sum(tract_vuln$underserved, na.rm = TRUE)\ntotal_vulnerable <- nrow(tract_vuln)\npct_underserved <- (num_underserved / total_vulnerable) * 100\n\n```\n\n**Questions to answer:**\n- How many tracts are underserved? 22 are underserved\n- What percentage of vulnerable tracts are underserved? 2.60% of vulnerable tracts are underserved\n- Does this surprise you? Why or why not? I am pleasantly surprised that there is not a higher percentage of vulnerable tracts that are underserved especially with regards to income being a factor as this limits where one can live. \n---\n\n#### Step 6: Aggregate to County Level\n\nUse spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.\n\n**Your Task:**\n```{r}\n# Spatial join tracts to counties\npa_counties_proj <- st_transform(pa_counties, st_crs(tract_vuln))\n\ntracts_county <- st_join(\n  tract_vuln,\n  pa_counties_proj %>% select(COUNTY_NAM),\n  join = st_within\n)\n\n# Aggregate statistics by county\n\ncounty_stats <- tracts_county %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarise(\n    n_vulnerable_tracts = n(),\n    n_underserved_tracts = sum(underserved, na.rm = TRUE),\n    pct_underserved = 100 * n_underserved_tracts / n_vulnerable_tracts,\n    avg_dist_miles = mean(dist_to_hospital_miles, na.rm = TRUE),\n    total_vulnerable_pop = sum(pop_65plus, na.rm = TRUE)\n  ) %>%\n  arrange(desc(pct_underserved))\n\ntop5_pct_underserved <- county_stats %>%\n  slice_max(pct_underserved, n = 5) %>%\n  select(COUNTY_NAM, pct_underserved, n_vulnerable_tracts, n_underserved_tracts)\n\ntop5_pct_underserved\n\n# View top 5 counties by total vulnerable population\ntop5_vulnerable_pop <- county_stats %>%\n  slice_max(total_vulnerable_pop, n = 5) %>%\n  select(COUNTY_NAM, total_vulnerable_pop, n_underserved_tracts)\n\ntop5_vulnerable_pop\n\n```\nUse spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.\n\n**Your Task:**\n```{r}\n#Spatial Understanding of where vulnerable counties are \n\npa_counties_proj <- st_transform(pa_counties, st_crs(tract_vuln))\n\ntracts_county <- st_join(\n  tract_vuln,\n  pa_counties_proj %>% select(COUNTY_NAM),\n  join = st_within\n)\n\n# Convert underserved to numeric so sum() works\ntracts_county <- tracts_county %>%\n  mutate(underserved_num = ifelse(underserved, 1, 0))\n\n# Aggregate statistics by county\ncounty_stats <- tracts_county %>%\n  st_drop_geometry() %>%\n  group_by(COUNTY_NAM) %>%\n  summarise(\n    n_vulnerable_tracts = n(),\n    n_underserved_tracts = sum(underserved_num, na.rm = TRUE),\n    pct_underserved = 100 * n_underserved_tracts / n_vulnerable_tracts,\n    avg_dist_miles = mean(dist_to_hospital_miles, na.rm = TRUE),\n    total_vulnerable_pop = sum(pop_65plus, na.rm = TRUE)\n  ) %>%\n  arrange(desc(pct_underserved))\n\n# View top 5 counties by pct underserved\ntop5_pct_underserved <- county_stats %>%\n  slice_max(pct_underserved, n = 5) %>%\n  select(COUNTY_NAM, pct_underserved, n_vulnerable_tracts, n_underserved_tracts)\n\ntop5_pct_underserved\n\n\n#to understand spatial patterns\nlibrary(ggplot2)\n\npa_counties_plot <- pa_counties_proj %>%\n  left_join(county_stats, by = \"COUNTY_NAM\")\n\n# Map: percent of vulnerable tracts that are underserved\nggplot(pa_counties_plot) +\n  geom_sf(aes(fill = pct_underserved), color = \"white\") +\n  scale_fill_viridis_c(option = \"magma\", direction = -1, \n                       na.value = \"grey90\", name = \"% Underserved\") +\n  labs(\n    title = \"Percent of Vulnerable Counties Underserved by Hospitals\",\n    subtitle = \"Pennsylvania Counties\",\n    caption = \"Data: Vulnerable tracts (>65+ elderly & low income) & hospital locations\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12)\n  )\n\n\n```\n\n\n\n**Required county-level statistics:**\n- Number of vulnerable tracts\n- Number of underserved tracts  \n- Percentage of vulnerable tracts that are underserved\n- Average distance to nearest hospital for vulnerable tracts\n- Total vulnerable population\n\n**Questions to answer:**\n- Which 5 counties have the highest percentage of underserved vulnerable tracts? \nCAMERON\t\t\nFOREST\t\t\nSULLIVAN\t\t\nMONROE\t\t\nJUNIATA\t\t\nPOTTER\n\n- Which counties have the most vulnerable people living far from hospitals?\nThe counties with the most vulnerable people living far from hospitals are:\nPHILADELPHIA\t\t\nALLEGHENY\t\t\nLUZERNE\t\t\nFAYETTE\t\nWESTMORELAND\n\n- Are there any patterns in where underserved counties are located?\nThe underserved counties are mainly in the northern half of the state  \n---\n\n#### Step 7: Create Summary Table \n\nCreate a professional table showing the top 10 priority counties for healthcare investment.\n\n**Your Task:**\n```{r}\n# Create and format priority counties table\ncounty_stats_2 <- county_stats %>%\n  mutate(\n    priority_score = n_vulnerable_tracts * 0.6 + total_vulnerable_pop * 0.4  # example weighting\n  )\n\nlibrary(scales)\n\n# Select top 10 priority counties\ntop10_priority <- county_stats_2 %>%\n  arrange(desc(priority_score)) %>%\n  slice(1:10) %>%\n  select(\n    County = COUNTY_NAM,\n    `Vulnerable & Remote Tracts` = n_vulnerable_tracts,\n    `Total Vulnerable Population` = total_vulnerable_pop,\n    `Priority Score` = priority_score\n  ) %>%\n  mutate(\n    `Total Vulnerable Population` = comma(`Total Vulnerable Population`),\n    `Priority Score` = round(`Priority Score`, 1)\n  )\n\n\n# Display professional table\nkable(\n  top10_priority,\n  caption = \"Top 10 Priority Counties for Healthcare Investment in Pennsylvania\",\n  align = c(\"l\", \"c\", \"c\", \"c\"),\n  digits = 0\n)\n\n\n```\n\n\n---\n\n## Part 2: Comprehensive Visualization \n### Map 1: County-Level Choropleth \n\nCreate a choropleth map showing healthcare access challenges at the county level.\n\n**Your Task:**\n```{r}\n# Create county-level access map\n\nlibrary(viridis)\n\n# Merge county statistics back to county geometries\npa_counties_plot <- pa_counties_proj %>%\n  left_join(county_stats_2, by = c(\"COUNTY_NAM\"))\n\n# Map: percent of vulnerable tracts underserved with hospital locations\nggplot(pa_counties_plot) +\n  # Counties filled by percent underserved\n  geom_sf(aes(fill = pct_underserved), color = \"transparent\") +\n  \n  # Hospitals as points\n  geom_sf(data = hospitals_proj, color = \"red\", size = 2, shape = 21, fill = \"red\") +\n  \n  # Color scale\n  scale_fill_viridis_c(\n    option = \"Blues\",\n    direction = -1,\n    na.value = \"grey80\",\n    name = \"% Vulnerable Tracts Underserved\"\n  ) +\n  \n  # Titles and caption\n  labs(\n    title = \"Healthcare Access Challenges Across Pennsylvania Counties\",\n    subtitle = \"Percent of vulnerable tracts underserved by hospitals (>15 miles away)\",\n    caption = \"Data Sources: ACS 2022, Pennsylvania Hospitals\"\n  ) +\n  \n  # Clean theme\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12),\n    plot.caption = element_text(size = 9),\n    legend.position = \"right\"\n  )\n\n\n```\n\n\n\n---\n\n### Map 2: Detailed Vulnerability Map \n\nCreate a map highlighting underserved vulnerable tracts.\n\n**Your Task:**\n```{r}\n\n# Create distribution visualization\n### Map 2: Detailed Vulnerability Map (Robust Version)\ntract_vuln <- tract_vuln %>% \n  filter(!st_is_empty(geometry)) %>% \n  st_make_valid()\n\npa_counties_proj <- pa_counties_proj %>%\n  filter(!st_is_empty(geometry)) %>%\n  st_make_valid()\n\nhospitals_proj <- hospitals_proj %>%\n  filter(!st_is_empty(geometry)) %>%\n  st_make_valid()\n\ntracts_vulnerable_only <- tract_vuln %>% \n  filter(vulnerable == TRUE) %>%\n  st_as_sf()\n\ntracts_underserved <- tract_vuln %>% \n  filter(underserved == TRUE) %>%\n  st_as_sf()\n\n\nst_is_valid(tracts_vulnerable_only) %>% table()\ntracts_vulnerable_only <- tracts_vulnerable_only %>%\n  filter(!st_is_empty(geometry), !is.na(st_dimension(geometry)))\nnrow(tracts_vulnerable_only)\nsum(st_is_empty(tracts_vulnerable_only))\n\nclass(tracts_vulnerable_only)\nst_geometry(tracts_vulnerable_only)\n#trial plot\n\nst_geometry(census_tracts)\n\ntracts_vulnerable_only <- census_tracts %>%\n  left_join(tracts_vulnerable_only %>% st_drop_geometry(), by = \"GEOID\") %>%\n  filter(vulnerable == TRUE)\n\n#refinement\ntracts_vulnerable_only <- tracts_vulnerable_only %>%\n  mutate(category = case_when(\n    underserved == TRUE ~ \"Underserved\",\n    vulnerable == TRUE ~ \"Vulnerable\",\n    TRUE ~ \"Other\"\n  ))\n\n\nggplot() +\n  geom_sf(data = pa_counties_proj, fill = \"grey95\", color = \"darkgrey\", size = 0.2) +\n  geom_sf(data = tracts_vulnerable_only, aes(fill = category), color = NA, alpha = 0.7) +\n  geom_sf(data = hospitals_proj, color = \"grey18\", fill = \"grey22\", shape = 21, size = 1) +\n  scale_fill_manual(\n    values = c(\n      \"Underserved\" = \"red\",\n      \"Vulnerable\" = \"firebrick4\",\n      \"Other\" = \"grey90\"\n    ),\n    name = \"Tract Category\"\n  ) +\n  labs(\n    title = \"Underserved and Vulnerable Populations in Pennsylvania\",\n    subtitle = \"Census tracts with elderly + low-income residents more than 15 miles from a hospital\",\n    caption = \"Data: ACS 2022, Pennsylvania Hospitals\"\n  ) +\n  theme_void() +\n  theme(\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12),\n    legend.position = \"bottom\",\n    legend.title = element_text(face = \"bold\"),\n    panel.grid = element_blank() \n  )\n\n\n```\n\n\n\n**Requirements:**\nI used a bright red to distinguish underserved vulnerable tracts, which are easy to see in contrast to the other tracts and the hospitals which are all darker tones. \n\n---\n\n### Chart: Distribution Analysis\n\nCreate a visualization showing the distribution of distances to hospitals for vulnerable populations.\n\n**Your Task:**\n```{r}\n# Create distribution visualization\n\nggplot(tract_vuln, aes(x = dist_to_hospital_miles)) +\n  geom_histogram(binwidth = 2, fill = \"steelblue\", color = \"white\", alpha = 0.8) +\n  geom_vline(xintercept = 15, linetype = \"dashed\", color = \"red\", size = 1) +\n  labs(\n    title = \"Distribution of Distances to Nearest Hospital (Vulnerable Tracts)\",\n    x = \"Distance to Nearest Hospital (miles)\",\n    y = \"Number of Vulnerable Tracts\",\n    caption = \"Dashed line = 15-mile underserved threshold\"\n  ) +\n  theme_minimal()\n\n\n\n\n```\n\n**Requirements:**\n- Brief interpretation \nMost vulnerable tracts are within a 15 miles of a hospital, a small portion of them are further than 15 miles from a hospital.\n\n---\n\n## Part 3: Bring Your Own Data Analysis \n\n### Challenge Options\n\n### Your Analysis\n\n**Your Task:**\n\n**Option B: School Safety Zones**\n- **Data:** Schools, Crime Incidents, Bike Network\n- **Question:** \"Are school zones safe for walking/biking, or are they crime hotspots?\"\n- **Operations:** Buffer schools (1000ft safety zone), spatial join with crime incidents, assess bike infrastructure coverage\n- **Policy relevance:** Safe Routes to School programs, crossing guard placement\n\n\n1. All three data sets come from **OpenDataPhilly:** https://opendataphilly.org/datasets/\n**Find and load additional data**\n   - Document your data source\n   - Check and standardize the CRS\n   - Provide basic summary statistics\n\n```{r}\n# Load your additional dataset\n\nschools <- st_read(\"C:/Users/ixche/Desktop/PPA/Working Files/lab_2/Schools.geojson\")\ncrime <- st_read(\"C:/Users/ixche/Desktop/PPA/Working Files/lab_2/incidents_part1_part2 (2)/incidents_part1_part2.shp\")\nbikenetwork <- st_read(\"C:/Users/ixche/Desktop/PPA/Working Files/lab_2/Bike_Network.geojson\")\n\ntarget_crs <- st_crs(2272)\nschools <- st_transform(schools, target_crs)\ncrime <- st_transform(crime, target_crs)\nbikenetwork <- st_transform(bikenetwork, target_crs)\n\nsummary(schools)\nsummary(crime)\nsummary(bikenetwork)\n```\n\n**Questions to answer:**\n- What dataset did you choose and why?\nThe datasets I used are Crime Incidents, Bike Network and Schools from OpenDataPhilly.\n\n- What is the data source and date?\nThe data source is OpenDataPhilly and it was accessed on October 19.\n\n- How many features does it contain?\nBikenetwork contains 9 variables, crime contains 14 variables and schools contains 15 variables.\n\n- What CRS is it in? Did you need to transform it?\nThe CRS was WGS 84, I transformed it for additional practice but they were all in the same coordinate reference system.\n---\n\n2. **Pose a research question**\nAre school zones safe for walking/biking, or are they crime hotspots?\n\n---\n\n3. **Conduct spatial analysis**\n\nI am using buffers and spatial joins to complete my analysis. \n\n**Your Task: Setting up the Data**\n```{r}\n# Your spatial analysis\n\nschool_buffers <- st_buffer(schools, dist = 1000)  # creates a 1000 ft safety zone around schools\n\nschool_buffers <- school_buffers %>%\n  rename(school_id = objectid) #rename the school ids so the columns have different names\n\ncrime <- crime %>%\n  rename(crime_id = objectid)\nschool_crime_counts <- st_join(school_buffers, crime, join = st_contains) %>%\n  group_by(school_id, school_name) %>%  # Use unique school ID\n  summarise(\n    n_crimes = n(),\n    .groups = \"drop\"\n  )\n\n#including the coverage of the bike network in Philly\nbike_in_buffers <- st_intersection(bikenetwork, school_buffers)\n\nbike_length_per_school <- bike_in_buffers %>%\n  group_by(school_id, school_name) %>%\n  summarise(\n    bike_length_ft = sum(st_length(geometry)),\n    .groups = \"drop\"\n  )\n\n#Bringing all the data together\n# Drop geometry for bike summary\nbike_length_per_school_df <- bike_length_per_school %>%\n  st_drop_geometry()\n\n# Now join safely\nschool_safety_summary <- school_crime_counts %>%\n  left_join(bike_length_per_school_df, by = c(\"school_id\", \"school_name\")) %>%\n  mutate(bike_length_ft = ifelse(is.na(bike_length_ft), 0, bike_length_ft))\n\n#Map of findings\nlibrary(ggplot2)\nlibrary(scales)\n\nschool_crime_counts_df <- st_drop_geometry(school_crime_counts)\n\n# Merge crime counts to school buffers for plotting\nschool_buffers_plot <- school_buffers %>%\n  left_join(school_crime_counts_df, by = c(\"school_id\", \"school_name\"))\n\nschool_buffers_plot <- school_buffers_plot %>%\n  mutate(n_crimes = ifelse(is.na(n_crimes), 0, n_crimes))\n\n# Highlight variation (e.g., sqrt)\nschool_buffers_plot <- school_buffers_plot %>%\n  mutate(n_crimes_sqrt = sqrt(n_crimes))\n\n```\n\n**Mapping**\n```{r}\n# Your spatial analysis\n\nggplot(school_buffers_plot) +\n  geom_sf(aes(fill = n_crimes), color = NA) +\n  scale_fill_viridis_c(option = \"inferno\", name = \"Crime Count\") +\n  labs(\n    title = \"Philadelphia School Safety Zones\",\n    subtitle = \"Crime incidents within 1000 ft of schools\",\n    caption = \"Source: OpenDataPhilly (2025)\"\n  ) +\n  theme_void() +\n  theme(\n    legend.position = \"right\",\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12)\n  )\n\n\n# Ensure both layers have the same CRS\nbikenetwork <- st_transform(bikenetwork, st_crs(school_buffers_plot))\n\n# --- 1. Intersect bike network with school buffers ---\n# This keeps only the bike segments that fall within 1000 ft of schools\nbike_in_buffers <- st_intersection(bikenetwork, school_buffers_plot)\n\n# --- 2. Map: Crime gradient + bike network inside buffers ---\nggplot() +\n  # School buffer polygons shaded by number of crimes\n  geom_sf(data = school_buffers_plot, aes(fill = n_crimes), color = NA) +\n  \n  # Bike network segments within buffers (cyan lines)\n  geom_sf(\n    data = bike_in_buffers,\n    color = \"cyan3\",\n    size = 0.6,\n    alpha = 0.8\n  ) +\n  \n  # Color scale for crime density\n  scale_fill_viridis_c(option = \"inferno\", name = \"Crime Count\") +\n  \n  # Titles and labels\n  labs(\n    title = \"Philadelphia School Safety Zones and Bike Network Coverage\",\n    subtitle = \"Bike network segments within 1000 ft of schools overlaid on crime density\",\n    caption = \"Source: OpenDataPhilly (2025)\"\n  ) +\n  \n  # Minimal map style\n  theme_void() +\n  theme(\n    legend.position = \"right\",\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12)\n  )\n\n\n```\n\n**Summary Statistics and Counts**\n```{r}\n# Summary Statistics for School Safety Analysis\n\n# 1. Total number of schools analyzed\nn_schools <- nrow(school_crime_counts)\n\n# 2. Total number of crimes within 1000 ft of schools\ntotal_crimes <- sum(school_crime_counts$n_crimes, na.rm = TRUE)\n\n# 3. Average number of crimes per school buffer\navg_crimes_per_school <- mean(school_crime_counts$n_crimes, na.rm = TRUE)\n\n# 4. Number (and percent) of schools with *zero* nearby crimes\nschools_no_crime <- sum(school_crime_counts$n_crimes == 0, na.rm = TRUE)\npct_no_crime <- round(100 * schools_no_crime / n_schools, 1)\n\n# 5. Bike network coverage summary\ntotal_bike_length <- sum(bike_length_per_school$bike_length_ft, na.rm = TRUE)\navg_bike_length <- mean(bike_length_per_school$bike_length_ft, na.rm = TRUE)\n\n#simple summary table\nsummary_table <- data.frame(\n  Metric = c(\n    \"Total schools analyzed\",\n    \"Total crimes within 1000 ft\",\n    \"Average crimes per school\",\n    \"Schools with no nearby crimes\",\n    \"Percent of schools with no nearby crimes\",\n    \"Total bike network length within 1000 ft (ft)\",\n    \"Average bike network length per school (ft)\"\n  ),\n  Value = c(\n    n_schools,\n    total_crimes,\n    round(avg_crimes_per_school, 1),\n    schools_no_crime,\n    paste0(pct_no_crime, \"%\"),\n    round(total_bike_length, 0),\n    round(avg_bike_length, 0)\n  )\n)\n\n# Display the table nicely\nlibrary(knitr)\nkable(summary_table, caption = \"Summary of School Zone Safety and Bike Access in Philadelphia\")\n\n\n\n```\n\n**Analysis requirements:**\n- Clear code comments explaining each step\n- Appropriate CRS transformations\n- Summary statistics or counts\n- At least one map showing your findings\n- Brief interpretation of results (3-5 sentences)\n\n**Your interpretation:**\nSchool zones are generally safe for biking and walking. Only 3 of the points in the 1000ft of school buffers have a 1000 or more crime incidents. The average number of crimes per school is 177 which is 0.14% of the crimes in Philadelphia. Since Philadelphia has 495 located throughout the city, this accounts for the high number for total crimes within 1000 feet of a school, which means it is more helpful to look at general trends of crime per school than this number alone.\n\n\n## Finally - A few comments about your incorporation of feedback!\nI deleted additional instructions and added additional headers to help with readability. \n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"embed-resources":true,"output-file":"Ramirez_Ixchel_Assignment2.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.24","theme":"cosmo","title":"Assignment 2: Spatial Analysis and Visualization","subtitle":"Healthcare Access and Equity in Pennsylvania","author":"Ixchel Ramirez","date":"October 19, 2025","toc-location":"left"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}